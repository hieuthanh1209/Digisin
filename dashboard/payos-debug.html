<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayOS Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #0a0; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß PayOS Debug Tool</h1>
    
    <div class="test-section">
        <h3>1. PayOS Configuration Check</h3>
        <button onclick="checkConfig()">Check Config</button>
        <div id="configResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Signature Generation Test</h3>
        <button onclick="testSignature()">Test Signature</button>
        <div id="signatureResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. PayOS API Test</h3>
        <button onclick="testPayOSAPI()">Test API Call</button>
        <div id="apiResult" class="result"></div>
    </div>

    <script>
        // PayOS Settings (copy from your main file)
        const PAYOS_SETTINGS = {
            CLIENT_ID: '763142a9-9de4-49fd-90e0-7a69efb063e0',
            API_KEY: '3b19b80b-d3d8-4632-b9a8-48a45fbe9085',
            CHECKSUM_KEY: 'a7e6a0d36be0b35e9977fd5486896b50d2457d71b2f5fb8968a52a6fa4ea5527',
            RETURN_URL: window.location.origin + '/dashboard/cashier-dashboard.html',
            CANCEL_URL: window.location.origin + '/dashboard/cashier-dashboard.html'
        };

        function checkConfig() {
            const result = document.getElementById('configResult');
            
            const checks = [
                { name: 'CLIENT_ID', value: PAYOS_SETTINGS.CLIENT_ID, valid: !!PAYOS_SETTINGS.CLIENT_ID },
                { name: 'API_KEY', value: PAYOS_SETTINGS.API_KEY, valid: !!PAYOS_SETTINGS.API_KEY },
                { name: 'CHECKSUM_KEY', value: PAYOS_SETTINGS.CHECKSUM_KEY, valid: !!PAYOS_SETTINGS.CHECKSUM_KEY && PAYOS_SETTINGS.CHECKSUM_KEY.length === 64 },
                { name: 'RETURN_URL', value: PAYOS_SETTINGS.RETURN_URL, valid: !!PAYOS_SETTINGS.RETURN_URL },
                { name: 'CANCEL_URL', value: PAYOS_SETTINGS.CANCEL_URL, valid: !!PAYOS_SETTINGS.CANCEL_URL }
            ];

            let html = '<h4>Configuration Status:</h4>';
            let allValid = true;

            checks.forEach(check => {
                const status = check.valid ? '‚úÖ' : '‚ùå';
                html += `<div>${status} ${check.name}: ${check.valid ? 'OK' : 'MISSING/INVALID'}</div>`;
                if (!check.valid) allValid = false;
            });

            html += `<div style="margin-top: 10px;"><strong>Overall: ${allValid ? '‚úÖ All Good' : '‚ùå Issues Found'}</strong></div>`;
            
            result.innerHTML = html;
            result.className = allValid ? 'result success' : 'result error';
        }

        async function testSignature() {
            const result = document.getElementById('signatureResult');
            
            try {
                const orderCode = Math.floor(Date.now() / 1000);
                const amount = 50000;
                const description = 'Test payment';
                
                result.innerHTML = '<div>Generating signature...</div>';
                
                const signature = await generatePayOSSignature(orderCode, amount, description);
                
                let html = '<h4>Signature Test Result:</h4>';
                html += `<div><strong>Order Code:</strong> ${orderCode}</div>`;
                html += `<div><strong>Amount:</strong> ${amount}</div>`;
                html += `<div><strong>Description:</strong> ${description}</div>`;
                html += `<div><strong>Signature:</strong> ${signature || 'FAILED'}</div>`;
                html += `<div><strong>Status:</strong> ${signature ? '‚úÖ Success' : '‚ùå Failed'}</div>`;
                
                result.innerHTML = html;
                result.className = signature ? 'result success' : 'result error';
                
            } catch (error) {
                result.innerHTML = `<div class="error">Signature Error: ${error.message}</div>`;
                result.className = 'result error';
            }
        }

        async function testPayOSAPI() {
            const result = document.getElementById('apiResult');
            
            try {
                result.innerHTML = '<div>Testing PayOS API...</div>';
                
                const orderCode = Math.floor(Date.now() / 1000);
                const amount = 50000;
                const description = 'Test payment';
                
                const signature = await generatePayOSSignature(orderCode, amount, description);
                
                const paymentData = {
                    orderCode: orderCode,
                    amount: amount,
                    description: description,
                    items: [
                        {
                            name: 'Test Item',
                            quantity: 1,
                            price: 50000
                        }
                    ],
                    returnUrl: PAYOS_SETTINGS.RETURN_URL,
                    cancelUrl: PAYOS_SETTINGS.CANCEL_URL,
                    signature: signature
                };

                console.log('Sending to PayOS:', paymentData);

                const response = await fetch('https://api-merchant.payos.vn/v2/payment-requests', {
                    method: 'POST',
                    headers: {
                        'x-client-id': PAYOS_SETTINGS.CLIENT_ID,
                        'x-api-key': PAYOS_SETTINGS.API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                const responseData = await response.json();
                
                let html = '<h4>PayOS API Test Result:</h4>';
                html += `<div><strong>HTTP Status:</strong> ${response.status}</div>`;
                html += `<div><strong>Response Code:</strong> ${responseData.code}</div>`;
                html += `<div><strong>Message:</strong> ${responseData.desc}</div>`;
                
                if (responseData.data && responseData.data.checkoutUrl) {
                    html += `<div><strong>Checkout URL:</strong> <a href="${responseData.data.checkoutUrl}" target="_blank">Open Payment</a></div>`;
                    html += `<div><strong>Status:</strong> ‚úÖ Success</div>`;
                    result.className = 'result success';
                } else {
                    html += `<div><strong>Status:</strong> ‚ùå Failed</div>`;
                    result.className = 'result error';
                }
                
                html += '<h5>Full Response:</h5>';
                html += `<pre>${JSON.stringify(responseData, null, 2)}</pre>`;
                
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = `<div class="error">API Test Error: ${error.message}</div>`;
                result.className = 'result error';
                console.error('PayOS API Test Error:', error);
            }
        }

        // Helper function to generate PayOS signature
        async function generatePayOSSignature(orderCode, amount, description) {
            try {
                const data = `amount=${amount}&cancelUrl=${PAYOS_SETTINGS.CANCEL_URL}&description=${description}&orderCode=${orderCode}&returnUrl=${PAYOS_SETTINGS.RETURN_URL}`;
                
                console.log('Signature data string:', data);
                
                const encoder = new TextEncoder();
                const keyData = encoder.encode(PAYOS_SETTINGS.CHECKSUM_KEY);
                const messageData = encoder.encode(data);
                
                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    keyData,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );
                
                const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
                const hashArray = Array.from(new Uint8Array(signature));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                console.log('Generated signature:', hashHex);
                return hashHex;
            } catch (error) {
                console.error('Signature generation error:', error);
                return '';
            }
        }
    </script>
</body>
</html> 