<!DOCTYPE html>
<html lang="vi">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý - Hệ thống Quản lý Nhà hàng</title>    <link rel="icon" href="../assets/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="manager-styles.css">
    <link rel="stylesheet" href="tax-settings.css">
      <!-- Custom styles for manager dashboard -->
    <style>        /* Prevent double scrollbars */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        /* Optimize table responsive behavior */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
          /* Ensure analytics tab doesn't create extra scrolling */
        #analytics-tab .card-body {
            overflow: visible;
        }
        
        /* Fixed sidebar styling */
        .sidebar {
            width: 300px !important;
            min-width: 300px;
            max-width: 300px;
            flex-shrink: 0;
            position: relative;
        }
        
        .manager-avatar-dropdown .dropdown-toggle::after {
            display: none;
        }
        
        .manager-avatar-dropdown .dropdown-menu {
            min-width: 250px;
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .manager-avatar-dropdown .dropdown-header {
            padding: 1rem;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 12px 12px 0 0;
            margin: -0.5rem -0.5rem 0.5rem -0.5rem;
        }
        
        .manager-avatar-dropdown .dropdown-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 0 0.5rem;
            transition: all 0.2s ease;
        }
        
        .manager-avatar-dropdown .dropdown-item:hover {
            background-color: #f8f9fa;
            transform: translateX(4px);
        }
        
        .manager-avatar-dropdown .dropdown-item.text-danger:hover {
            background-color: #fff5f5;
            color: #dc3545 !important;
        }
        
        .user-avatar-btn {
            transition: all 0.2s ease;
            border-radius: 25px;
            padding: 4px 8px 4px 4px;
        }
        
        .user-avatar-btn:hover {
            background-color: #f8f9fa !important;
            transform: scale(1.02);
        }
          .manager-info-text {
            line-height: 1.2;
        }
        
        /* Enhanced Dashboard Styles */
        .stats-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
        
        .bg-success-soft {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        
        .bg-primary-soft {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }
        
        .circular-progress {
            transform: rotate(-90deg);
        }
        
        .circular-progress circle {
            transition: stroke-dashoffset 0.5s ease;
        }
        
        .quick-action-btn {
            transition: all 0.3s ease;
            border-radius: 12px;
            height: 80px;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        }
        
        .btn-outline-purple {
            color: #6f42c1;
            border-color: #6f42c1;
        }
        
        .btn-outline-purple:hover {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white;
        }
        
        .list-group-item {
            transition: background-color 0.2s ease;
        }
        
        .list-group-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        .card {
            border-radius: 12px;
        }
        
        .rounded-circle {
            border-radius: 50% !important;
        }
          .text-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Additional enhancements */
        .badge {
            font-weight: 500;
        }
        
        .bg-danger-soft {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
        
        .card-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .display-6 {
            font-size: 2rem;
            font-weight: 600;
        }
        
        .small {
            font-size: 0.875em;
        }
        
        .h4 {
            font-size: 1.5rem;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .quick-action-btn {
                height: 70px;
                padding: 0.75rem;
            }
            
            .quick-action-btn .small {
                font-size: 0.75rem;
            }
            
            .stats-card .card-body {
                padding: 1rem;
            }
            
            .display-6 {
                font-size: 1.5rem;
            }
        }
        
        /* Custom scrollbar */
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
          .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Overview specific styles */
        .icon-shape {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        
        .bg-primary-soft {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }
        
        .bg-success-soft {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        
        .bg-warning-soft {
            background-color: rgba(255, 193, 7, 0.1) !important;
        }
        
        .bg-info-soft {
            background-color: rgba(13, 202, 240, 0.1) !important;
        }
        
        .bg-danger-soft {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
        
        .text-primary { color: #007bff !important; }
        .text-success { color: #198754 !important; }
        .text-warning { color: #ffc107 !important; }
        .text-info { color: #0dcaf0 !important; }
        .text-danger { color: #dc3545 !important; }
        
        /* Progress bars */
        .progress {
            border-radius: 10px;
        }
        
        .progress-bar {
            border-radius: 10px;
        }
        
        /* Badge styles */
        .badge {
            font-size: 0.7em;
            padding: 0.4em 0.6em;
            border-radius: 6px;
        }
        
        /* Responsive overview */
        @media (max-width: 768px) {
            .icon-shape {
                width: 50px;
                height: 50px;
            }
        }
    </style>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Password Management JavaScript -->
    <script>
        // Password management functions
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('staffPassword');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.setAttribute('data-lucide', 'eye-off');
            } else {
                passwordInput.type = 'password';
                toggleIcon.setAttribute('data-lucide', 'eye');
            }
            
            // Refresh lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function generateRandomPassword() {
            const length = 12;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let password = "";
            
            // Ensure at least one character from each category
            const lowercase = "abcdefghijklmnopqrstuvwxyz";
            const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const numbers = "0123456789";
            const symbols = "!@#$%^&*";
            
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += symbols[Math.floor(Math.random() * symbols.length)];
            
            // Fill the rest randomly
            for (let i = 4; i < length; i++) {
                password += charset[Math.floor(Math.random() * charset.length)];
            }
            
            // Shuffle the password
            password = password.split('').sort(() => Math.random() - 0.5).join('');
            
            document.getElementById('staffPassword').value = password;
            checkPasswordStrength(password);
            
            // Show a toast notification
            if (typeof showToast === 'function') {
                showToast('Mật khẩu đã được tạo tự động!', 'success');
            }
        }

        function togglePasswordChange() {
            const checkbox = document.getElementById('changePasswordCheckbox');
            const passwordInput = document.getElementById('staffPassword');
            const generateBtn = document.getElementById('generatePasswordBtn');
            const passwordHelp = document.getElementById('passwordHelp');
            
            if (checkbox.checked) {
                passwordInput.disabled = false;
                passwordInput.required = true;
                generateBtn.disabled = false;
                passwordHelp.textContent = 'Nhập mật khẩu mới cho nhân viên này. Mật khẩu nên có ít nhất 6 ký tự.';
                passwordInput.focus();
            } else {
                passwordInput.disabled = true;
                passwordInput.required = false;
                passwordInput.value = '';
                generateBtn.disabled = true;
                passwordHelp.textContent = 'Chọn "Đổi mật khẩu" để cập nhật mật khẩu cho nhân viên này.';
                document.getElementById('passwordStrength').style.display = 'none';
            }
        }

        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('passwordStrengthText');
            
            if (!password || password.length === 0) {
                strengthDiv.style.display = 'none';
                return;
            }
            
            strengthDiv.style.display = 'block';
            
            let score = 0;
            let feedback = [];
            
            // Length check
            if (password.length >= 8) score += 25;
            else if (password.length >= 6) score += 15;
            else feedback.push('ít nhất 6 ký tự');
            
            // Character variety checks
            if (/[a-z]/.test(password)) score += 15;
            else feedback.push('chữ thường');
            
            if (/[A-Z]/.test(password)) score += 15;
            else feedback.push('chữ hoa');
            
            if (/[0-9]/.test(password)) score += 15;
            else feedback.push('số');
            
            if (/[^A-Za-z0-9]/.test(password)) score += 30;
            else feedback.push('ký tự đặc biệt');
            
            // Update progress bar
            strengthBar.style.width = score + '%';
            
            // Update color and text
            if (score >= 80) {
                strengthBar.className = 'progress-bar bg-success';
                strengthText.textContent = 'Mật khẩu mạnh';
                strengthText.className = 'text-success small';
            } else if (score >= 60) {
                strengthBar.className = 'progress-bar bg-warning';
                strengthText.textContent = 'Mật khẩu trung bình';
                strengthText.className = 'text-warning small';
            } else {
                strengthBar.className = 'progress-bar bg-danger';
                strengthText.textContent = 'Mật khẩu yếu - Cần: ' + feedback.join(', ');
                strengthText.className = 'text-danger small';
            }
        }

        // Function to setup staff modal for add/edit mode
        function setupStaffModalMode(isEdit = false) {
            const changePasswordCheck = document.getElementById('changePasswordCheck');
            const changePasswordCheckbox = document.getElementById('changePasswordCheckbox');
            const passwordInput = document.getElementById('staffPassword');
            const generateBtn = document.getElementById('generatePasswordBtn');
            const passwordHelp = document.getElementById('passwordHelp');
            
            if (isEdit) {
                // Edit mode - show change password option
                changePasswordCheck.style.display = 'block';
                changePasswordCheckbox.checked = false;
                passwordInput.disabled = true;
                passwordInput.required = false;
                passwordInput.value = '';
                generateBtn.disabled = true;
                passwordHelp.textContent = 'Chọn "Đổi mật khẩu" để cập nhật mật khẩu cho nhân viên này.';
                document.getElementById('passwordStrength').style.display = 'none';
            } else {
                // Add mode - password is required
                changePasswordCheck.style.display = 'none';
                passwordInput.disabled = false;
                passwordInput.required = true;
                passwordInput.value = '';
                generateBtn.disabled = false;
                passwordHelp.textContent = 'Khi thêm nhân viên mới, mật khẩu là bắt buộc để tạo tài khoản đăng nhập. Mật khẩu nên có ít nhất 6 ký tự.';
                document.getElementById('passwordStrength').style.display = 'none';
            }
        }        // Setup password input event listener when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('staffPassword');
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    checkPasswordStrength(this.value);
                });
            }
            
            // Load manager information when page loads
            loadManagerInfo();
            
            // Show welcome message
            setTimeout(() => {
                const managerInfo = getManagerInfoFromStorage();
                if (typeof showToast === 'function') {
                    showSuccessToast(`Xin chào ${managerInfo.name}, chào mừng bạn quay trở lại!`, 3000);
                }
            }, 500);
        });

        // Manager Information Management Functions
        function loadManagerInfo() {
            // Get manager info from localStorage or use defaults
            const managerInfo = getManagerInfoFromStorage();
            updateManagerDisplay(managerInfo);
        }

        function getManagerInfoFromStorage() {
            const defaultManager = {
                name: 'Quản lý hệ thống',
                email: 'manager@restaurant.com',
                role: 'Quản lý hệ thống',
                avatar: null,
                loginTime: new Date().toISOString()
            };

            try {
                const stored = localStorage.getItem('managerInfo');
                return stored ? { ...defaultManager, ...JSON.parse(stored) } : defaultManager;
            } catch (error) {
                console.error('Error loading manager info:', error);
                return defaultManager;
            }
        }

        function updateManagerDisplay(managerInfo) {
            // Update header display
            const managerNameEl = document.getElementById('managerName');
            const managerRoleEl = document.getElementById('managerRole');
            const managerAvatarEl = document.getElementById('managerAvatar');
            
            // Update dropdown display
            const dropdownNameEl = document.getElementById('dropdownManagerName');
            const dropdownEmailEl = document.getElementById('dropdownManagerEmail');

            // Set name and role
            if (managerNameEl) managerNameEl.textContent = managerInfo.name;
            if (managerRoleEl) managerRoleEl.textContent = managerInfo.role;
            if (dropdownNameEl) dropdownNameEl.textContent = managerInfo.name;
            if (dropdownEmailEl) dropdownEmailEl.textContent = managerInfo.email;

            // Set avatar
            if (managerAvatarEl) {
                if (managerInfo.avatar) {
                    managerAvatarEl.src = managerInfo.avatar;
                } else {
                    // Generate avatar using UI Avatars service
                    const initials = managerInfo.name.split(' ').map(n => n[0]).join('');
                    managerAvatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(managerInfo.name)}&background=007bff&color=fff&size=40&rounded=true`;
                }
            }
        }

        function showManagerProfile() {
            // Show manager profile modal (you can implement this later)
            if (typeof showToast === 'function') {
                showToast('Chức năng thông tin cá nhân đang được phát triển', 'info');
            } else {
                alert('Chức năng thông tin cá nhân đang được phát triển');
            }
        }

        // This function is now implemented at the bottom of the file
        // Keep this reference for backward compatibility
        function showSettings() {
            if (typeof window.showSettings === 'function') {
                window.showSettings();
            } else {
                alert('Chức năng cài đặt hệ thống đang được khởi tạo. Vui lòng thử lại.');
            }
        }        function userLogout() {
            // Create a custom confirmation modal instead of using browser alert
            const logoutModal = document.createElement('div');
            logoutModal.innerHTML = `
                <div class="modal fade" id="logoutConfirmModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i data-lucide="log-out" style="width: 20px; height: 20px;" class="me-2"></i>
                                    Xác nhận đăng xuất
                                </h5>
                            </div>
                            <div class="modal-body">
                                <p class="mb-3">Bạn có chắc chắn muốn đăng xuất khỏi hệ thống quản lý?</p>
                                <div class="alert alert-warning">
                                    <small><i data-lucide="alert-triangle" style="width: 16px; height: 16px;" class="me-1"></i>
                                    Tất cả dữ liệu chưa lưu sẽ bị mất.</small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i data-lucide="x" style="width: 16px; height: 16px;" class="me-1"></i>
                                    Hủy
                                </button>
                                <button type="button" class="btn btn-danger" id="confirmLogoutBtn">
                                    <i data-lucide="log-out" style="width: 16px; height: 16px;" class="me-1"></i>
                                    Đăng xuất
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(logoutModal);
            
            // Initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('logoutConfirmModal'));
            modal.show();
            
            // Handle confirm logout
            document.getElementById('confirmLogoutBtn').addEventListener('click', function() {
                performLogout();
                modal.hide();
                
                // Remove modal from DOM after animation
                setTimeout(() => {
                    document.body.removeChild(logoutModal);
                }, 300);
            });
        }        function performLogout() {
            try {
                const managerInfo = getManagerInfoFromStorage();
                
                // First, sign out from Firebase using the imported logout function
                if (typeof window.logout === 'function') {
                    window.logout().then(() => {
                        console.log('✅ Firebase logout successful');
                        
                        // Clear session data
                        localStorage.removeItem('managerSession');
                        localStorage.removeItem('userRole');
                        localStorage.removeItem('loginTime');
                        localStorage.removeItem('managerInfo');
                        
                        // Show logout success message
                        if (typeof showSuccessToast === 'function') {
                            showSuccessToast(`Tạm biệt ${managerInfo.name}, hẹn gặp lại!`, 2000);
                        } else if (typeof showToast === 'function') {
                            showToast('Đã đăng xuất thành công!', 'success');
                        }
                        
                        // Add logout effect
                        document.body.style.transition = 'opacity 0.5s ease';
                        document.body.style.opacity = '0';
                        
                        // Redirect to main page after animation
                        setTimeout(() => {
                            window.location.href = '../index.html';
                        }, 1000);
                        
                    }).catch((error) => {
                        console.error('❌ Firebase logout failed:', error);
                        
                        // Still clear local data and redirect even if Firebase logout fails
                        localStorage.removeItem('managerSession');
                        localStorage.removeItem('userRole');
                        localStorage.removeItem('loginTime');
                        localStorage.removeItem('managerInfo');
                        
                        if (typeof showWarningToast === 'function') {
                            showWarningToast('Đăng xuất thành công (có lỗi nhỏ)', 2000);
                        }
                        
                        setTimeout(() => {
                            window.location.href = '../index.html';
                        }, 1000);
                    });
                } else {
                    // Fallback if Firebase logout is not available
                    console.warn('Firebase logout function not available, performing local logout only');
                    
                    // Clear session data
                    localStorage.removeItem('managerSession');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('loginTime');
                    localStorage.removeItem('managerInfo');
                    
                    if (typeof showSuccessToast === 'function') {
                        showSuccessToast(`Tạm biệt ${managerInfo.name}, hẹn gặp lại!`, 2000);
                    }
                    
                    // Add logout effect
                    document.body.style.transition = 'opacity 0.5s ease';
                    document.body.style.opacity = '0';
                    
                    // Redirect to main page after animation
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error during logout:', error);
                
                // Force logout and redirect even if there's an error
                localStorage.clear();
                window.location.href = '../index.html';
            }
        }
        
        // Function to set manager information (can be called from login page)
        function setManagerInfo(info) {
            try {
                const managerInfo = {
                    name: info.name || 'Quản lý hệ thống',
                    email: info.email || 'manager@restaurant.com',
                    role: info.role || 'Quản lý hệ thống',
                    avatar: info.avatar || null,
                    loginTime: new Date().toISOString(),
                    ...info
                };
                
                localStorage.setItem('managerInfo', JSON.stringify(managerInfo));
                localStorage.setItem('managerSession', 'active');
                localStorage.setItem('userRole', 'manager');
                localStorage.setItem('loginTime', managerInfo.loginTime);
                
                updateManagerDisplay(managerInfo);
                
                console.log('Manager info updated:', managerInfo);
            } catch (error) {
                console.error('Error saving manager info:', error);
            }
        }

        // Make setManagerInfo globally available so it can be called from other pages
        window.setManagerInfo = setManagerInfo;        // Function to check if user is logged in as manager
        async function checkManagerAuth() {
            try {
                const userRole = localStorage.getItem('userRole');
                const managerSession = localStorage.getItem('managerSession');
                const managerInfo = getManagerInfoFromStorage();
                
                console.log('🔐 Checking manager authentication...');
                console.log('Local userRole:', userRole);
                console.log('Manager session:', managerSession);
                console.log('Manager info:', managerInfo);
                
                // Check local storage first
                if (userRole !== 'manager' || !managerSession) {
                    console.warn('❌ No manager credentials in localStorage');
                    redirectToLogin('Không có quyền truy cập trang quản lý');
                    return false;
                }
                
                // Additional check: verify manager role
                if (managerInfo && managerInfo.role) {
                    const role = managerInfo.role.toLowerCase();
                    if (role !== 'quản lý' && role !== 'manager' && role !== 'quản lý hệ thống') {
                        console.warn('❌ User role is not manager:', managerInfo.role);
                        redirectToLogin('Chỉ có quản lý mới được truy cập trang này');
                        return false;
                    }
                }
                
                // Check session validity (optional: 8 hours max)
                const loginTime = localStorage.getItem('loginTime');
                if (loginTime) {
                    const loginDate = new Date(loginTime);
                    const now = new Date();
                    const sessionDuration = now - loginDate;
                    const maxSessionDuration = 8 * 60 * 60 * 1000; // 8 hours
                    
                    if (sessionDuration > maxSessionDuration) {
                        console.warn('❌ Session expired');
                        redirectToLogin('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại');
                        return false;
                    }
                }
                
                console.log('✅ Manager authentication successful');
                return true;
                
            } catch (error) {
                console.error('❌ Error checking manager auth:', error);
                redirectToLogin('Lỗi xác thực. Vui lòng đăng nhập lại');
                return false;
            }
        }
        
        // Function to redirect to login with message
        function redirectToLogin(message) {
            // Clear any existing session data
            localStorage.removeItem('managerSession');
            localStorage.removeItem('userRole');
            localStorage.removeItem('loginTime');
            localStorage.removeItem('managerInfo');
            
            // Store error message to show on login page
            if (message) {
                sessionStorage.setItem('loginError', message);
            }
            
            // Show message before redirect
            if (typeof showErrorToast === 'function') {
                showErrorToast(message || 'Vui lòng đăng nhập với tài khoản quản lý', 3000);
            }
            
            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = '../index.html';
            }, 2000);
        }// Check authentication when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Enable authentication check for manager access
            checkManagerAuth();
            
            // Initialize session timeout
            initSessionTimeout();
        });

        // Session timeout management
        let sessionTimeoutId;
        let warningTimeoutId;
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
        const WARNING_TIMEOUT = 25 * 60 * 1000; // 25 minutes (5 minutes before logout)

        function initSessionTimeout() {
            resetSessionTimeout();
            
            // Reset timeout on user activity
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetSessionTimeout, { passive: true });
            });
        }

        function resetSessionTimeout() {
            // Clear existing timeouts
            if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
            if (warningTimeoutId) clearTimeout(warningTimeoutId);
            
            // Set warning timeout (5 minutes before auto-logout)
            warningTimeoutId = setTimeout(showSessionWarning, WARNING_TIMEOUT);
            
            // Set auto-logout timeout
            sessionTimeoutId = setTimeout(autoLogout, SESSION_TIMEOUT);
        }

        function showSessionWarning() {
            if (typeof showWarningToast === 'function') {
                showWarningToast('Phiên làm việc sắp hết hạn. Nhấn vào đây để tiếp tục.', 10000);
            } else if (typeof showToast === 'function') {
                showToast('Phiên làm việc sắp hết hạn trong 5 phút!', 'warning');
            }
        }

        function autoLogout() {
            if (typeof showErrorToast === 'function') {
                showErrorToast('Phiên làm việc đã hết hạn. Đang đăng xuất...', 3000);
            } else if (typeof showToast === 'function') {
                showToast('Phiên làm việc đã hết hạn!', 'error');
            }
            
            // Perform logout after showing message
            setTimeout(() => {
                performLogout();
            }, 2000);
        }
    </script>
</head>
<body>
    <div class="d-flex vh-100">        <!-- Sidebar -->
        <div class="sidebar bg-white shadow-lg border-end">
            <div class="p-4 border-bottom">
                <h1 class="h3 fw-bold text-dark mb-1">Quản lý</h1>
                <p class="text-muted mb-0">Hệ thống điều hành</p>
            </div>
            <nav class="p-3">                <button class="nav-button btn w-100 text-start mb-3 p-3" onclick="location.href='../index.html'">
                    🏠 <span class="ms-2">Trang chủ</span>
                </button>
                <button class="nav-button nav-button-active btn w-100 text-start mb-3 p-3" onclick="showTab('overview')">
                    📊 <span class="ms-2">Tổng quan</span>
                </button>
                <button class="nav-button btn w-100 text-start mb-3 p-3" onclick="showTab('staff')">
                    👥 <span class="ms-2">Quản lý nhân viên</span>
                </button>
                <button class="nav-button btn w-100 text-start mb-3 p-3" onclick="showTab('analytics')">
                    📋 <span class="ms-2">Thống kê nâng cao</span>
                </button>
                <button class="nav-button btn w-100 text-start mb-3 p-3" onclick="showTab('menu')">
                    🍽️ <span class="ms-2">Quản lý thực đơn</span>
                </button>
                <button class="nav-button btn w-100 text-start mb-3 p-3" onclick="showTab('inventory')">
                    📦 <span class="ms-2">Quản lý kho</span>
                </button>
                <button class="nav-button btn w-100 text-start mb-3 p-3" onclick="showTab('finance')">
                    💰 <span class="ms-2">Quản lý thu chi</span>
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-fill d-flex flex-column">            <!-- Header -->
            <div class="bg-white shadow-sm border-bottom p-4 d-flex align-items-center justify-content-between">
                <h2 class="h4 mb-0" id="pageTitle">Tổng quan hệ thống</h2>                <div class="d-flex align-items-center">
                    <div class="me-3 manager-info-text">
                        <small class="text-muted">Xin chào, <span class="fw-medium" id="managerName">Quản lý</span></small>
                        <br>
                        <small class="text-primary" id="managerRole">Quản lý hệ thống</small>
                    </div>
                    <!-- User Avatar Dropdown -->
                    <div class="dropdown manager-avatar-dropdown">
                        <button class="user-avatar-btn btn p-0 border-0 bg-transparent" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="d-flex align-items-center">
                                <img id="managerAvatar" src="https://ui-avatars.com/api/?name=Manager&background=007bff&color=fff&size=40&rounded=true" 
                                     alt="Manager Avatar" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                <i data-lucide="chevron-down" style="width: 16px; height: 16px;" class="text-muted"></i>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li>
                                <div class="dropdown-header">
                                    <div class="fw-medium" id="dropdownManagerName">Quản lý</div>
                                    <small class="opacity-75" id="dropdownManagerEmail">manager@restaurant.com</small>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="showManagerProfile()">
                                    <i data-lucide="user" style="width: 16px; height: 16px;" class="me-2"></i>
                                    Thông tin cá nhân
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="showSettings()">
                                    <i data-lucide="settings" style="width: 16px; height: 16px;" class="me-2"></i>
                                    Cài đặt hệ thống
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="userLogout()">
                                    <i data-lucide="log-out" style="width: 16px; height: 16px;" class="me-2"></i>
                                    Đăng xuất
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>            <!-- Tab Content -->
            <div class="flex-fill p-4 bg-light" style="min-height: 0; overflow-y: auto;">
                
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content active">
                    <!-- Overview Statistics Cards -->
                    <div class="row g-4 mb-4">
                        <!-- Today's Revenue -->
                        <div class="col-xl-3 col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="text-muted fw-normal mb-1">Doanh thu hôm nay</h6>
                                            <h3 class="mb-0 fw-bold text-primary" id="overviewTodayRevenue">0₫</h3>
                                            <small class="text-muted">
                                                <span id="overviewRevenueChange" class="badge bg-success-soft text-success">+0%</span>
                                                so với hôm qua
                                            </small>
                                        </div>
                                        <div class="icon-shape bg-primary-soft text-primary rounded-3">
                                            <i data-lucide="trending-up" style="width: 24px; height: 24px;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>                        <!-- Active Tables -->
                        <div class="col-xl-3 col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="text-muted fw-normal mb-1">Bàn đang phục vụ</h6>
                                            <h3 class="mb-0 fw-bold text-warning" id="overviewActiveTables">0</h3>
                                            <small class="text-muted">
                                                / <span id="overviewTotalTables">20</span> tổng số bàn
                                            </small>
                                            <br>
                                            <small class="text-info">Trạng thái: occupied</small>
                                        </div>
                                        <div class="icon-shape bg-warning-soft text-warning rounded-3">
                                            <i data-lucide="users" style="width: 24px; height: 24px;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Staff -->
                        <div class="col-xl-3 col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="text-muted fw-normal mb-1">Nhân viên đang làm</h6>
                                            <h3 class="mb-0 fw-bold text-success" id="overviewActiveStaff">0</h3>
                                            <small class="text-muted">
                                                / <span id="overviewTotalStaff">12</span> tổng số
                                            </small>
                                        </div>
                                        <div class="icon-shape bg-success-soft text-success rounded-3">
                                            <i data-lucide="user-check" style="width: 24px; height: 24px;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Today's Orders -->
                        <div class="col-xl-3 col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="text-muted fw-normal mb-1">Đơn hàng hôm nay</h6>
                                            <h3 class="mb-0 fw-bold text-info" id="overviewTodayOrders">0</h3>
                                            <small class="text-muted">
                                                <span id="overviewOrdersChange" class="badge bg-info-soft text-info">+0</span>
                                                so với hôm qua
                                            </small>
                                        </div>
                                        <div class="icon-shape bg-info-soft text-info rounded-3">
                                            <i data-lucide="shopping-bag" style="width: 24px; height: 24px;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mb-4">
                        <!-- 7-Day Revenue Chart -->
                        <div class="col-lg-8">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Doanh thu 7 ngày qua</h5>                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshRevenueChart()">
                                        <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                                        Cập nhật
                                    </button>
                                </div>
                                <div class="card-body">
                                    <canvas id="weeklyRevenueChart" height="100"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Inventory Status -->
                        <div class="col-lg-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Tình trạng kho</h5>
                                    <span class="badge bg-warning" id="lowStockCount">0</span>
                                </div>
                                <div class="card-body p-0">
                                    <div id="inventoryStatusList">
                                        <!-- Inventory status items will be rendered here -->
                                    </div>
                                    <div class="p-3 bg-light">
                                        <button class="btn btn-sm btn-outline-primary w-100" onclick="showTab('inventory')">
                                            Xem chi tiết kho
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Finance Transactions -->
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">5 giao dịch Thu/Chi gần nhất</h5>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showTab('finance')">
                                        Xem tất cả
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Ngày</th>
                                                    <th>Mã phiếu</th>
                                                    <th>Loại</th>
                                                    <th>Danh mục</th>
                                                    <th>Mô tả</th>
                                                    <th class="text-end">Số tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentFinanceTransactions">
                                                <!-- Recent transactions will be rendered here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="financeEmptyOverview" class="text-center p-4 d-none">
                                        <i data-lucide="file-text" style="width: 48px; height: 48px;" class="text-muted mb-2"></i>
                                        <p class="text-muted mb-0">Chưa có giao dịch thu chi nào</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Management Tab -->
                <div id="staff-tab" class="tab-content">
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Danh sách nhân viên</h5>
                                    <button class="btn btn-primary" onclick="showAddStaffModal()">
                                        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                        Thêm nhân viên
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Mã NV</th>
                                                    <th>Họ tên</th>
                                                    <th>Chức vụ</th>
                                                    <th>Số điện thoại</th>
                                                    <th>Email</th>
                                                    <th>Trạng thái</th>
                                                    <th>Thao tác</th>
                                                </tr>
                                            </thead>
                                            <tbody id="staffTableBody">
                                                <!-- Staff data will be rendered here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                </div>

                <!-- Analytics Tab -->
                <div id="analytics-tab" class="tab-content">
                    <div class="row g-4">
                        <!-- Profitability Analysis Summary -->
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">Phân tích lợi nhuận (30 ngày gần nhất)</h5>
                                </div>
                                <div class="card-body">
                                    <div id="profitabilityAnalysis">
                                        <!-- Profitability analysis will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Selling Items -->
                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">Top 10 món bán chạy nhất</h5>
                                </div>
                                <div class="card-body">
                                    <div id="topSellingItems">
                                        <!-- Top selling items will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Category Revenue -->
                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">Doanh thu theo danh mục</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="categoryRevenueChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Revenue Trend -->
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">Xu hướng doanh thu 7 ngày gần nhất</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="revenueByTimeChart" height="150"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Daily Items Detail -->
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Phân tích chi tiết từng món ăn</h5>
                                    <small class="text-muted">Sắp xếp theo số lượng bán</small>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Món ăn</th>
                                                    <th>Danh mục</th>
                                                    <th class="text-center">Số lượng bán</th>
                                                    <th class="text-end">Doanh thu</th>
                                                    <th class="text-end">Lợi nhuận</th>
                                                    <th class="text-center">Tỷ lệ lợi nhuận</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dailyItemsTable">
                                                <!-- Daily items data will be rendered here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Management Tab -->                <div id="menu-tab" class="tab-content">
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">Quản lý thực đơn</h5>
                                        <small class="text-muted">Quản lý món ăn và công thức</small>
                                    </div>                                    <button class="btn btn-primary" onclick="showAddMenuItemModal()">
                                        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                        Thêm món
                                    </button>
                                </div>
                                <div class="card-body">
                                    <!-- Menu Filters -->
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                                                </span>
                                                <input type="text" class="form-control" placeholder="Tìm kiếm món ăn..." id="menuSearchInput" oninput="filterMenuItems()">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="menuCategoryFilter" onchange="filterMenuByCategory()">
                                                <option value="all">Tất cả danh mục</option>
                                                <!-- Categories loaded from Firestore -->
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="menuStatusFilter" onchange="filterMenuItems()">
                                                <option value="all">Tất cả trạng thái</option>
                                                <option value="active">Đang bán</option>
                                                <option value="inactive">Ngừng bán</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Menu Items Grid -->
                                    <div class="row g-4" id="menuItemsGrid">
                                        <!-- Menu items will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div id="inventory-tab" class="tab-content">
                    <div class="row">
                        <!-- Inventory Alerts -->
                        <div class="col-12 mb-4">
                            <div class="alert alert-warning" id="inventoryAlert" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <i data-lucide="alert-triangle" class="me-2" style="width: 20px; height: 20px;"></i>
                                    <div>
                                        <strong>Cảnh báo tồn kho!</strong>
                                        <span id="alertMessage"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="card border-0 shadow-sm">                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">Kiểm soát định lượng nguyên liệu</h5>
                                        <small class="text-muted">Theo dõi mức tiêu thụ với độ lệch cho phép 5-10%</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline-success me-2" onclick="exportInventoryToExcel()">
                                            <i data-lucide="file-spreadsheet" style="width: 16px; height: 16px;"></i>
                                            Xuất Excel
                                        </button>
                                        <button class="btn btn-primary" onclick="showAddIngredientModal()">
                                            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                            Thêm nguyên liệu
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Mã NL</th>
                                                    <th>Tên nguyên liệu</th>
                                                    <th>Đơn vị</th>
                                                    <th>Định mức chuẩn</th>
                                                    <th>Tồn kho</th>
                                                    <th>Đã dùng hôm nay</th>
                                                    <th>Trạng thái</th>
                                                    <th>Độ lệch</th>
                                                    <th>Thao tác</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inventoryTableBody">
                                                <!-- Inventory data will be rendered here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Tab -->
                <div id="finance-tab" class="tab-content">
                    <div class="row">
                        <!-- Finance Summary -->
                        <div class="col-12 mb-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between mb-4">
                                        <h4 class="card-title mb-0">Tổng quan thu chi</h4>                                        <div>
                                            <button class="btn btn-sm btn-outline-secondary me-2" id="refreshFinanceBtn">
                                                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                                                Cập nhật
                                            </button>
                                            <button class="btn btn-sm btn-outline-success me-2" id="syncOrdersBtn">
                                                <i data-lucide="database" style="width: 16px; height: 16px;"></i>
                                                Đồng bộ orders
                                            </button>
                                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#financeTransactionModal">
                                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                                Thêm phiếu thu/chi
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-4 mb-4">
                                        <div class="col-lg-3 col-md-6">
                                            <div class="bg-light p-3 rounded-3">
                                                <p class="text-muted mb-1 small">Tổng thu (tháng)</p>
                                                <h4 class="fw-bold mb-0" id="monthlyIncome">0₫</h4>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="bg-light p-3 rounded-3">
                                                <p class="text-muted mb-1 small">Tổng chi (tháng)</p>
                                                <h4 class="fw-bold mb-0" id="monthlyExpense">0₫</h4>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="bg-light p-3 rounded-3">
                                                <p class="text-muted mb-1 small">Lợi nhuận (tháng)</p>
                                                <h4 class="fw-bold mb-0" id="monthlyProfit">0₫</h4>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6">
                                            <div class="bg-light p-3 rounded-3">
                                                <p class="text-muted mb-1 small">Lợi nhuận (năm)</p>
                                                <h4 class="fw-bold mb-0" id="yearlyProfit">0₫</h4>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filters -->
                                    <div class="card mb-4">
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">Từ ngày</label>
                                                    <input type="date" class="form-control" id="financeStartDate">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Đến ngày</label>
                                                    <input type="date" class="form-control" id="financeEndDate">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Loại phiếu</label>
                                                    <select class="form-select" id="financeType">
                                                        <option value="all">Tất cả</option>
                                                        <option value="income">Thu</option>
                                                        <option value="expense">Chi</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Danh mục</label>
                                                    <select class="form-select" id="financeCategory">
                                                        <option value="all">Tất cả</option>
                                                        <option value="sales">Doanh thu bán hàng</option>
                                                        <option value="inventory">Nhập hàng</option>
                                                        <option value="salary">Lương nhân viên</option>
                                                        <option value="utilities">Điện nước, tiện ích</option>
                                                        <option value="rent">Tiền thuê mặt bằng</option>
                                                        <option value="other">Khác</option>
                                                    </select>
                                                </div>
                                                <div class="col-12">
                                                    <button class="btn btn-primary" id="filterFinanceBtn">
                                                        <i data-lucide="filter" style="width: 16px; height: 16px;"></i>
                                                        Lọc dữ liệu
                                                    </button>
                                                    <button class="btn btn-outline-secondary ms-2" id="exportFinanceBtn">
                                                        <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                                                        Xuất Excel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Finance Transactions Table -->
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Mã phiếu</th>
                                                    <th>Ngày</th>
                                                    <th>Loại</th>
                                                    <th>Danh mục</th>
                                                    <th>Mô tả</th>
                                                    <th>Số tiền</th>
                                                    <th>Ghi chú</th>
                                                    <th>Thao tác</th>
                                                </tr>
                                            </thead>
                                            <tbody id="financeTableBody">
                                                <!-- Finance data will be rendered here -->
                                            </tbody>
                                        </table>
                                        <div id="financeEmptyState" class="text-center p-4 d-none">
                                            <img src="https://cdn-icons-png.flaticon.com/512/2855/2855027.png" alt="No data" style="width: 80px; height: 80px; opacity: 0.3;">
                                            <p class="text-muted mt-3">Không có dữ liệu thu chi nào trong khoảng thời gian này</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div class="modal fade" id="staffModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staffModalTitle">Thêm nhân viên mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="staffForm">
                        <input type="hidden" id="editStaffId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Mã nhân viên</label>
                                <input type="text" class="form-control" id="staffId" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Họ tên</label>
                                <input type="text" class="form-control" id="staffName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chức vụ</label>
                                <select class="form-select" id="staffPosition" required>
                                    <option value="">Chọn chức vụ</option>
                                    <option value="Thu ngân">Thu ngân</option>
                                    <option value="Phục vụ">Phục vụ</option>
                                    <option value="Đầu bếp">Đầu bếp</option>
                                    <option value="Quản lý">Quản lý</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="staffPhone" required>
                            </div>                            <div class="col-12">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="staffEmail" required>
                            </div>                            <div class="col-12" id="passwordSection">
                                <label class="form-label">Mật khẩu</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="staffPassword" placeholder="Nhập mật khẩu">
                                    <button type="button" class="btn btn-outline-secondary" id="generatePasswordBtn" onclick="generateRandomPassword()">
                                        <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i>
                                        Tạo tự động
                                    </button>
                                </div>
                                <div class="form-check mt-2" id="changePasswordCheck" style="display: none;">
                                    <input class="form-check-input" type="checkbox" id="changePasswordCheckbox" onchange="togglePasswordChange()">
                                    <label class="form-check-label" for="changePasswordCheckbox">
                                        Đổi mật khẩu cho nhân viên này
                                    </label>
                                </div>
                                <small class="text-muted" id="passwordHelp">
                                    Khi thêm nhân viên mới, mật khẩu là bắt buộc để tạo tài khoản đăng nhập. Mật khẩu nên có ít nhất 6 ký tự.
                                </small>
                                <div id="passwordStrength" class="mt-1" style="display: none;">
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar" id="passwordStrengthBar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="passwordStrengthText"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày bắt đầu</label>
                                <input type="date" class="form-control" id="staffStartDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Lương (VNĐ)</label>
                                <input type="number" class="form-control" id="staffSalary" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveStaff()">Lưu</button>
                </div>
            </div>
        </div>
    </div>    <!-- Menu Item Modal -->
    <div class="modal fade" id="menuItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="menuModalTitle">Thêm món mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="menuItemForm">
                        <div class="row">
                            <input type="hidden" id="menuItemId" value="">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="menuItemName">Tên món</label>
                                <input type="text" class="form-control" id="menuItemName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="menuItemCategory">Danh mục</label>
                                <input type="text" class="form-control" id="menuItemCategory" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="menuItemPrice">Giá bán (VNĐ)</label>
                                <input type="number" class="form-control" id="menuItemPrice" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="menuItemCost">Giá vốn (VNĐ)</label>
                                <input type="number" class="form-control" id="menuItemCost">
                            </div>
                        </div>                        <div class="mb-3">
                            <label class="form-label" for="menuItemImage">URL Hình ảnh</label>
                            <input type="url" class="form-control" id="menuItemImage" placeholder="https://example.com/image.jpg">
                            <div id="menuItemImagePreview" class="mt-2">
                                <small class="text-muted">Nhập URL hình ảnh để hiển thị xem trước</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="menuItemDescription">Mô tả</label>
                            <textarea class="form-control" id="menuItemDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="menuItemStatus">Trạng thái</label>
                            <select class="form-select" id="menuItemStatus">
                                <option value="active">Đang bán</option>
                                <option value="inactive">Ngưng bán</option>
                            </select>
                        </div>                        <div class="mb-3">
                            <label class="form-label d-flex justify-content-between">
                                <span>Nguyên liệu</span>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addIngredientRow()">
                                    <i data-lucide="plus" class="icon-sm"></i> Thêm nguyên liệu
                                </button>
                            </label>
                            <div id="ingredientsList" class="border rounded p-3 bg-light">
                                <!-- Ingredient rows will be added here -->
                                <div class="text-muted small mt-2">Chọn nguyên liệu và nhập định lượng cần thiết cho món ăn này</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="flex: 0 0 auto; background: #fff; border-top: 1px solid #dee2e6; padding: 1rem 1.5rem; margin-top: auto;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveMenuItem()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredient Modal -->
    <div class="modal fade" id="ingredientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ingredientModalTitle">Thêm nguyên liệu mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ingredientForm">
                        <input type="hidden" id="editIngredientId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Mã nguyên liệu</label>
                                <input type="text" class="form-control" id="ingredientId" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tên nguyên liệu</label>
                                <input type="text" class="form-control" id="ingredientName" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Đơn vị</label>
                                <input type="text" class="form-control" id="ingredientUnit" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Định mức chuẩn</label>
                                <input type="number" class="form-control" id="ingredientStandard" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ngưỡng cảnh báo</label>
                                <input type="number" class="form-control" id="ingredientThreshold" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tồn kho hiện tại</label>
                                <input type="number" class="form-control" id="ingredientStock" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Giá thành (VNĐ)</label>
                                <input type="number" class="form-control" id="ingredientCost" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveIngredient()">Lưu</button>
                </div>
            </div>
        </div>
    </div>    <!-- Finance Transaction Modal -->
    <div class="modal fade" id="financeTransactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="financeModalTitle">Thêm phiếu thu/chi mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="financeForm">
                        <input type="hidden" id="editFinanceId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Mã phiếu</label>
                                <input type="text" class="form-control" id="financeCode" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày</label>
                                <input type="date" class="form-control" id="financeDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Loại phiếu</label>
                                <select class="form-select" id="financeTypeInput" required>
                                    <option value="">Chọn loại phiếu</option>
                                    <option value="income">Thu</option>
                                    <option value="expense">Chi</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Danh mục</label>
                                <select class="form-select" id="financeCategoryInput" required>
                                    <option value="">Chọn danh mục</option>
                                    <option value="sales">Doanh thu bán hàng</option>
                                    <option value="inventory">Nhập hàng</option>
                                    <option value="salary">Lương nhân viên</option>
                                    <option value="utilities">Điện nước, tiện ích</option>
                                    <option value="rent">Tiền thuê mặt bằng</option>
                                    <option value="other">Khác</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Mô tả</label>
                                <input type="text" class="form-control" id="financeDescription" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số tiền (VNĐ)</label>
                                <input type="number" class="form-control" id="financeAmount" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phương thức thanh toán</label>
                                <select class="form-select" id="financePaymentMethod">
                                    <option value="cash">Tiền mặt</option>
                                    <option value="transfer">Chuyển khoản</option>
                                    <option value="card">Thẻ</option>
                                </select>
                            </div>                            <div class="col-12">
                                <label class="form-label">Ghi chú</label>
                                <textarea class="form-control" id="financeNote" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Additional Information Section (shown only when editing) -->
                    <div id="financeAdditionalInfo" style="display: none;" class="mt-4 p-3 bg-light rounded">
                        <!-- Additional info content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveFinanceTransaction()">Lưu</button>
                </div>
            </div>
        </div>
    </div>    <!-- Toast Container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="toastContainer"></div>
    </div>    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="../src/utils/vat-manager.js"></script>
    <script src="../src/utils/vat-label-calculator.js"></script><!-- Firebase -->    <script type="module">        // Import Firebase functions
        import { 
            // Core Firebase functions
            db,
            collection,
            doc,
            getDocs,
            updateDoc,
            setDoc,
            deleteDoc,
            Timestamp,
            // Menu Functions
            getAllMenuItems,
            getMenuItemById,
            addMenuItem,
            updateMenuItem,
            deleteMenuItem,
            uploadMenuImage,
            filterMenuItemsByCategory,
            getMenuCategories,
            getAllStaff,
            getStaffById,
            addStaffMember,
            updateStaffMember,
            deleteStaffMember,
            getActiveStaffCount,
            // Inventory Functions
            getAllInventoryItems,
            getInventoryItemById,
            addInventoryItem,
            updateInventoryItem, 
            deleteInventoryItem,
            getLowStockItems,
            getHighVarianceItems,
            updateInventoryFromReadyOrder,            // Finance Functions
            getAllFinanceTransactions,
            getFinanceTransactionById,
            addFinanceTransaction,
            updateFinanceTransaction,
            deleteFinanceTransaction,
            getFinanceTransactionsByDateRange,
            getFinanceTransactionsByType,
            getFinanceTransactionsByCategory,
            getFinanceSummary,            // Order Functions
            getAllOrders,
            getOrderById,
            getPaidOrders,
            isOrderRecordedInFinance,
            createFinanceTransactionFromOrder,
            syncPaidOrdersToFinance,
            autoSyncNewPaidOrders,            getCashierNameById,
            enhanceFinanceTransactionWithCashierName,
            createFirebaseUser,
            logout
        } from './firebase-manager.js';
        
        // Import Toast functions
        import { showToast, showSuccessToast, showErrorToast, showWarningToast, showInfoToast } from '../src/components/ui/toast-helper.js';
          // Make Toast functions globally available
        window.showToast = showToast;
        window.showSuccessToast = showSuccessToast;
        window.showErrorToast = showErrorToast;
        window.showWarningToast = showWarningToast;
        window.showInfoToast = showInfoToast;
          // Make core Firebase functions globally available
        window.db = db;
        window.collection = collection;
        window.doc = doc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.Timestamp = Timestamp;
        
        // Make Firebase functions globally available
        window.getAllMenuItems = getAllMenuItems;
        window.getMenuItemById = getMenuItemById;
        window.addMenuItem = addMenuItem;
        window.updateMenuItem = updateMenuItem;
        window.deleteMenuItem = deleteMenuItem;
        window.uploadMenuImage = uploadMenuImage;
        window.filterMenuItemsByCategory = filterMenuItemsByCategory;
        window.getMenuCategories = getMenuCategories;
        
        // Make Staff functions globally available
        window.getAllStaff = getAllStaff;
        window.getStaffById = getStaffById;
        window.addStaffMember = addStaffMember;
        window.updateStaffMember = updateStaffMember;
        window.deleteStaffMember = deleteStaffMember;
        window.getActiveStaffCount = getActiveStaffCount;
        
        // Make Inventory functions globally available
        window.getAllInventoryItems = getAllInventoryItems;
        window.getInventoryItemById = getInventoryItemById;
        window.addInventoryItem = addInventoryItem;
        window.updateInventoryItem = updateInventoryItem;
        window.deleteInventoryItem = deleteInventoryItem;        
        window.getLowStockItems = getLowStockItems;
        window.getHighVarianceItems = getHighVarianceItems;
        window.updateInventoryFromReadyOrder = updateInventoryFromReadyOrder;
          // Make Finance functions globally available
        window.getAllFinanceTransactions = getAllFinanceTransactions;
        window.getFinanceTransactionById = getFinanceTransactionById;
        window.addFinanceTransaction = addFinanceTransaction;
        window.updateFinanceTransaction = updateFinanceTransaction;
        window.deleteFinanceTransaction = deleteFinanceTransaction;
        window.getFinanceTransactionsByDateRange = getFinanceTransactionsByDateRange;
        window.getFinanceTransactionsByType = getFinanceTransactionsByType;
        window.getFinanceTransactionsByCategory = getFinanceTransactionsByCategory;
        window.getFinanceSummary = getFinanceSummary;
          // Make Order functions globally available
        window.getAllOrders = getAllOrders;
        window.getOrderById = getOrderById;
        window.getPaidOrders = getPaidOrders;
        window.isOrderRecordedInFinance = isOrderRecordedInFinance;
        window.createFinanceTransactionFromOrder = createFinanceTransactionFromOrder;
        window.syncPaidOrdersToFinance = syncPaidOrdersToFinance;
        window.autoSyncNewPaidOrders = autoSyncNewPaidOrders;
        window.getCashierNameById = getCashierNameById;        window.enhanceFinanceTransactionWithCashierName = enhanceFinanceTransactionWithCashierName;
        
        window.createFirebaseUser = createFirebaseUser;
        window.logout = logout;
    </script>    
    <script src="manager-script.js"></script>
    <script src="overview-functions.js"></script>
    <script src="tax-manager.js"></script>
       <script>
        // Enhanced Dashboard Functions
        
        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second
            
            // Initialize performance metrics
            updatePerformanceMetrics();
              // Auto-refresh data every 2 minutes (more frequent for revenue updates)
            setInterval(refreshDashboardData, 2 * 60 * 1000);
            
            // Also refresh when window gains focus (user comes back to tab)
            window.addEventListener('focus', () => {
                console.log('🔄 Window gained focus, refreshing dashboard data...');
                refreshDashboardData();
            });
        });
        
        function initializeDashboard() {
            // Load manager info and update welcome message
            const managerInfo = getManagerInfoFromStorage();
            document.getElementById('welcomeManagerName').textContent = managerInfo.name;
            
            // Load dashboard data
            refreshDashboardData();
        }
        
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            };
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN', timeOptions);
        }
        
        function refreshDashboardData() {
            console.log('Refreshing dashboard data...');
            
            // Update stats with sample data (replace with real Firebase data)
            updateStats();
            updatePerformanceMetrics();
            updateRecentActivities();
            updateSystemStatus();
            updateAdditionalInfo();
            
            if (typeof showToast === 'function') {
                showToast('Dữ liệu đã được cập nhật', 'success');
            }
        }
          function updateStats() {
            updateRealStats();
        }        async function updateRealStats() {
            try {
                const timestamp = new Date().toISOString();
                console.log(`📊 [${timestamp}] Fetching real revenue data from paid orders...`);
                
                // Get today's date range
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0, 0);
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59, 999);
                
                // Get yesterday's date range for comparison
                const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                const startOfYesterday = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 0, 0, 0, 0);
                const endOfYesterday = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 23, 59, 59, 999);
                
                // 1. Sync paid orders to finance first (wait for completion)
                try {
                    console.log('🔄 Syncing paid orders to finance transactions BEFORE fetching orders...');
                    await syncPaidOrdersToFinance();
                    console.log('✅ Sync completed');
                } catch (syncError) {
                    console.warn('⚠️ Sync failed:', syncError);
                }
                  // 2. Calculate revenue from income transactions for today
                console.log('🔄 Calculating today\'s revenue from finance transactions...');
                const todayResult = await calculateRevenueFromTransactions(startOfDay, endOfDay);
                const todayRevenue = todayResult.totalRevenue;
                const todayIncomeTransactions = todayResult.transactions;
                
                console.log(`💰 Today's revenue from transactions: ${formatCurrency(todayRevenue)} from ${todayIncomeTransactions.length} transactions`);

                // 3. Calculate revenue from income transactions for yesterday
                console.log('� Calculating yesterday\'s revenue from finance transactions...');
                const yesterdayResult = await calculateRevenueFromTransactions(startOfYesterday, endOfYesterday);
                const yesterdayRevenue = yesterdayResult.totalRevenue;
                const yesterdayIncomeTransactions = yesterdayResult.transactions;

                console.log(`💰 Yesterday's revenue from transactions: ${formatCurrency(yesterdayRevenue)} from ${yesterdayIncomeTransactions.length} transactions`);
                
                // 4. Also get order counts for reference
                console.log('🔄 Getting order counts...');
                const allOrders = await getAllOrders();
                
                // Filter orders for today
                const todayPaidOrders = allOrders.filter(order => {
                    if (order.paymentStatus !== 'paid') return false;
                    
                    let orderDate = null;
                    if (order.updatedAt) {
                        const dateToCheck = order.updatedAt;
                        if (typeof dateToCheck.toDate === 'function') {
                            orderDate = dateToCheck.toDate();
                        } else if (dateToCheck instanceof Date) {
                            orderDate = dateToCheck;
                        } else if (typeof dateToCheck === 'string' || typeof dateToCheck === 'number') {
                            orderDate = new Date(dateToCheck);
                        }
                    } else if (order.paidAt) {
                        const dateToCheck = order.paidAt;
                        if (typeof dateToCheck.toDate === 'function') {
                            orderDate = dateToCheck.toDate();
                        } else if (dateToCheck instanceof Date) {
                            orderDate = dateToCheck;
                        } else if (typeof dateToCheck === 'string' || typeof dateToCheck === 'number') {
                            orderDate = new Date(dateToCheck);
                        }
                    } else if (order.createdAt) {
                        const dateToCheck = order.createdAt;
                        if (typeof dateToCheck.toDate === 'function') {
                            orderDate = dateToCheck.toDate();
                        } else if (dateToCheck instanceof Date) {
                            orderDate = dateToCheck;
                        } else if (typeof dateToCheck === 'string' || typeof dateToCheck === 'number') {
                            orderDate = new Date(dateToCheck);
                        }
                    }
                    
                    if (!orderDate || isNaN(orderDate.getTime())) return false;
                    return orderDate >= startOfDay && orderDate <= endOfDay;
                });
                
                // Filter orders for yesterday
                const yesterdayPaidOrders = allOrders.filter(order => {
                    if (order.paymentStatus !== 'paid') return false;
                    
                    let orderDate = null;
                    const dateToCheck = order.updatedAt || order.paidAt || order.createdAt;
                    
                    if (dateToCheck && typeof dateToCheck.toDate === 'function') {
                        orderDate = dateToCheck.toDate();
                    } else if (dateToCheck instanceof Date) {
                        orderDate = dateToCheck;
                    } else if (dateToCheck) {
                        orderDate = new Date(dateToCheck);
                    }
                    
                    if (!orderDate || isNaN(orderDate.getTime())) return false;
                    return orderDate >= startOfYesterday && orderDate <= endOfYesterday;
                });
                
                console.log(`� Today's order count: ${todayPaidOrders.length}, Yesterday's order count: ${yesterdayPaidOrders.length}`);
                
                // Get staff data
                let activeStaff = 0;
                let totalStaff = 0;
                try {
                    const allStaff = await getAllStaff();
                    totalStaff = allStaff.length;
                    activeStaff = allStaff.filter(staff => staff.status === 'active').length;
                } catch (error) {
                    console.warn('Could not fetch staff data:', error);
                    activeStaff = 8; // fallback
                    totalStaff = 12; // fallback
                }// Update revenue display
                const revenueElement = document.getElementById('todayRevenue');
                const overviewRevenueElement = document.getElementById('overviewTodayRevenue');
                const formattedRevenue = formatCurrency(todayRevenue);
                
                if (revenueElement) {
                    revenueElement.textContent = formattedRevenue;
                }
                if (overviewRevenueElement) {
                    overviewRevenueElement.textContent = formattedRevenue;
                }
                
                // Calculate and display revenue change
                const revenueChangeEl = document.getElementById('revenueChange');
                const overviewRevenueChangeEl = document.getElementById('overviewRevenueChange');
                if (yesterdayRevenue > 0) {
                    const revenueChange = ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100);
                    const changeText = `${revenueChange > 0 ? '+' : ''}${revenueChange.toFixed(1)}%`;
                    const changeClass = `badge ${revenueChange >= 0 ? 'bg-success-soft text-success' : 'bg-danger-soft text-danger'}`;
                    
                    if (revenueChangeEl) {
                        revenueChangeEl.textContent = changeText;
                        revenueChangeEl.className = changeClass + ' me-2';
                    }
                    if (overviewRevenueChangeEl) {
                        overviewRevenueChangeEl.textContent = changeText;
                        overviewRevenueChangeEl.className = changeClass;
                    }
                } else {
                    const changeText = todayRevenue > 0 ? 'Mới' : '0%';
                    const changeClass = 'badge bg-info-soft text-info';
                    
                    if (revenueChangeEl) {
                        revenueChangeEl.textContent = changeText;
                        revenueChangeEl.className = changeClass + ' me-2';
                    }
                    if (overviewRevenueChangeEl) {
                        overviewRevenueChangeEl.textContent = changeText;
                        overviewRevenueChangeEl.className = changeClass;
                    }
                }
                
                // Update orders count
                const ordersElement = document.getElementById('todayOrders');
                const overviewOrdersElement = document.getElementById('overviewTodayOrders');
                if (ordersElement) {
                    ordersElement.textContent = todayPaidOrders.length;
                }
                if (overviewOrdersElement) {
                    overviewOrdersElement.textContent = todayPaidOrders.length;
                }
                
                // Calculate and display orders change
                const ordersChangeEl = document.getElementById('ordersChange');
                const overviewOrdersChangeEl = document.getElementById('overviewOrdersChange');
                const ordersChange = todayPaidOrders.length - yesterdayPaidOrders.length;
                const ordersChangeText = `${ordersChange > 0 ? '+' : ''}${ordersChange}`;
                const ordersChangeClass = `badge ${ordersChange >= 0 ? 'bg-primary-soft text-primary' : 'bg-danger-soft text-danger'}`;
                
                if (ordersChangeEl) {
                    ordersChangeEl.textContent = ordersChangeText;
                    ordersChangeEl.className = ordersChangeClass + ' me-2';
                }
                if (overviewOrdersChangeEl) {
                    overviewOrdersChangeEl.textContent = ordersChangeText;
                    overviewOrdersChangeEl.className = ordersChangeClass;
                }
                  // Update staff
                const activeStaffEl = document.getElementById('activeStaff');
                const totalStaffEl = document.getElementById('totalStaff');
                const overviewActiveStaffEl = document.getElementById('overviewActiveStaff');
                const overviewTotalStaffEl = document.getElementById('overviewTotalStaff');
                
                if (activeStaffEl) activeStaffEl.textContent = activeStaff;
                if (totalStaffEl) totalStaffEl.textContent = `/ ${totalStaff} tổng số`;
                if (overviewActiveStaffEl) overviewActiveStaffEl.textContent = activeStaff;
                if (overviewTotalStaffEl) overviewTotalStaffEl.textContent = totalStaff;
                
                // Update tables (using sample data for now)
                const activeTablesEl = document.getElementById('activeTables');
                const totalTablesEl = document.getElementById('totalTables');
                const overviewActiveTablesEl = document.getElementById('overviewActiveTables');
                const overviewTotalTablesEl = document.getElementById('overviewTotalTables');
                
                const sampleActiveTables = 15; // TODO: Get from orders/tables data
                const sampleTotalTables = 20;   // TODO: Get from configuration
                
                if (activeTablesEl) activeTablesEl.textContent = sampleActiveTables;
                if (totalTablesEl) totalTablesEl.textContent = `/ ${sampleTotalTables} tổng số`;
                if (overviewActiveTablesEl) overviewActiveTablesEl.textContent = sampleActiveTables;
                if (overviewTotalTablesEl) overviewTotalTablesEl.textContent = sampleTotalTables;
                
                console.log('✅ Stats updated successfully');
                
                // Update last refresh time
                const lastUpdateElement = document.getElementById('lastUpdated');
                if (lastUpdateElement) {
                    const now = new Date();
                    lastUpdateElement.textContent = `Cập nhật lúc: ${now.toLocaleTimeString('vi-VN')}`;
                }
                
                // Show success notification
                if (typeof showInfoToast === 'function') {
                    showInfoToast(`Dữ liệu đã được cập nhật - ${new Date().toLocaleTimeString('vi-VN')}`);
                }
                
            } catch (error) {
                console.error('❌ Error updating real stats:', error);
                
                // Fallback to sample data on error
                const fallbackStats = {
                    todayRevenue: 0,
                    todayOrders: 0,
                    activeStaff: 0,
                    totalStaff: 0
                };
                
                const revenueElement = document.getElementById('todayRevenue');
                if (revenueElement) revenueElement.textContent = formatCurrency(fallbackStats.todayRevenue);
                
                const ordersElement = document.getElementById('todayOrders');
                if (ordersElement) ordersElement.textContent = fallbackStats.todayOrders;
                
                const activeStaffEl = document.getElementById('activeStaff');
                if (activeStaffEl) activeStaffEl.textContent = fallbackStats.activeStaff;
                
                if (typeof showErrorToast === 'function') {
                    showErrorToast('Không thể tải dữ liệu doanh thu. Hiển thị dữ liệu mặc định.');
                }
            }
        }
        
        function updatePerformanceMetrics() {
            // Sample performance data
            const metrics = {
                revenueTarget: 70,
                ordersTarget: 60,
                satisfaction: 85,
                efficiency: 92
            };
            
            updateCircularProgress('revenueProgress', 'revenuePercentage', metrics.revenueTarget);
            updateCircularProgress('ordersProgress', 'ordersPercentage', metrics.ordersTarget);
            updateCircularProgress('satisfactionProgress', 'satisfactionPercentage', metrics.satisfaction);
            updateCircularProgress('efficiencyProgress', 'efficiencyPercentage', metrics.efficiency);
        }
        
        function updateCircularProgress(progressId, percentageId, value) {
            const circle = document.getElementById(progressId);
            const percentage = document.getElementById(percentageId);
            
            if (circle && percentage) {
                const circumference = 2 * Math.PI * 35; // radius = 35
                const offset = circumference - (value / 100) * circumference;
                
                circle.style.strokeDasharray = circumference;
                circle.style.strokeDashoffset = offset;
                percentage.textContent = `${value}%`;
            }
        }
        
        function updateRecentActivities() {
            // This would typically fetch from Firebase
            // For now, we keep the static activities
            console.log('Recent activities updated');
        }
        
        function updateSystemStatus() {
            // Simulate system status checks
            const statuses = ['success', 'warning', 'danger'];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            
            // You can update system status indicators here
            console.log('System status updated:', status);
        }
        
        function updateAdditionalInfo() {
            // Sample additional data
            document.getElementById('avgOrderValue').textContent = formatCurrency(181000);
            document.getElementById('avgServiceTime').textContent = '12 phút';
            document.getElementById('peakHour').textContent = '19:30';
        }
        
        function changeMetricsPeriod(period) {
            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update metrics based on period
            console.log('Changing metrics period to:', period);
            updatePerformanceMetrics();
            
            if (typeof showToast === 'function') {
                showToast(`Đã chuyển sang ${period === 'today' ? 'hôm nay' : period === 'week' ? 'tuần này' : 'tháng này'}`, 'info');
            }
        }
          function refreshRevenueChart() {
            console.log('Refreshing revenue chart...');
            if (typeof showToast === 'function') {
                showToast('Đang cập nhật biểu đồ doanh thu...', 'info');
            }
            
            // Call the loadWeeklyRevenueChart function to refresh with real-time data
            loadWeeklyRevenueChart().then(() => {
                if (typeof showToast === 'function') {
                    showToast('Biểu đồ doanh thu đã được cập nhật thành công', 'success');
                }
            }).catch(error => {
                console.error('Error refreshing revenue chart:', error);
                if (typeof showErrorToast === 'function') {
                    showErrorToast('Lỗi khi cập nhật biểu đồ doanh thu');
                }
            });
        }
        
        function refreshTopDishesChart() {
            console.log('Refreshing top dishes chart...');
            if (typeof showToast === 'function') {
                showToast('Đang cập nhật biểu đồ món bán chạy...', 'info');
            }
            // Add chart refresh logic here
        }
        
        function openPrintReport() {
            if (typeof showToast === 'function') {
                showToast('Đang chuẩn bị báo cáo để in...', 'info');
            }
            
            // Create print window
            setTimeout(() => {
                const printContent = generatePrintReport();
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            }, 1000);
        }
        
        function generatePrintReport() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('vi-VN');
            const timeStr = now.toLocaleTimeString('vi-VN');
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Báo cáo tổng quan - ${dateStr}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                        .stat-item { text-align: center; }
                        .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
                        .stat-label { font-size: 14px; color: #666; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>BÁO CÁO TỔNG QUAN NHÀI HÀNG</h1>
                        <p>Ngày: ${dateStr} - Giờ: ${timeStr}</p>
                    </div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">${document.getElementById('todayRevenue').textContent}</div>
                            <div class="stat-label">Doanh thu hôm nay</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${document.getElementById('todayOrders').textContent}</div>
                            <div class="stat-label">Đơn hàng hôm nay</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${document.getElementById('activeStaff').textContent}</div>
                            <div class="stat-label">Nhân viên đang làm</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${document.getElementById('activeTables').textContent}</div>
                            <div class="stat-label">Bàn đang phục vụ</div>
                        </div>
                    </div>

                    <p style="margin-top: 40px; text-align: center; color: #666; font-size: 12px;">
                        Báo cáo được tạo tự động bởi hệ thống quản lý nhà hàng
                    </p>
                </body>
                </html>
            `;        }
        
        // Function to manually sync paid orders to finance transactions
        async function performOrdersSync() {
            const syncBtn = document.getElementById('syncOrdersBtn');
            if (!syncBtn) return;
            
            // Disable button and show loading
            const originalText = syncBtn.innerHTML;
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> Đang đồng bộ...';
            
            try {
                console.log('🔄 Starting manual orders sync...');
                
                // Call the sync function from firebase-manager
                const results = await syncPaidOrdersToFinance();
                
                console.log('✅ Manual sync completed:', results);
                
                // Show success message
                let message = `Đồng bộ hoàn tất: ${results.processed} đơn được xử lý`;
                if (results.skipped > 0) {
                    message += `, ${results.skipped} đơn đã tồn tại`;
                }
                if (results.errors > 0) {
                    message += `, ${results.errors} lỗi`;
                }
                
                if (typeof showSuccessToast === 'function') {
                    showSuccessToast(message);
                } else {
                    alert(message);
                }
                
                // Refresh dashboard data after sync
                setTimeout(() => {
                    updateRealStats();
                }, 1000);
                
            } catch (error) {
                console.error('❌ Manual sync failed:', error);
                
                const errorMessage = 'Lỗi đồng bộ orders: ' + (error.message || 'Không xác định');
                if (typeof showErrorToast === 'function') {
                    showErrorToast(errorMessage);
                } else {
                    alert(errorMessage);
                }
            } finally {
                // Restore button
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
                
                // Recreate icons since we changed innerHTML
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }
          // Function to force refresh revenue data
        async function forceRefreshRevenue() {
            console.log('🔄 Force refreshing revenue data...');
            
            // Show loading indicator
            const revenueElement = document.getElementById('todayRevenue');
            const overviewRevenueElement = document.getElementById('overviewTodayRevenue');
            
            if (revenueElement) {
                revenueElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tải...';
            }
            if (overviewRevenueElement) {
                overviewRevenueElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tải...';
            }
            
            try {
                await updateRealStats();
                
                if (typeof showSuccessToast === 'function') {
                    showSuccessToast('Dữ liệu doanh thu đã được cập nhật!');
                }
            } catch (error) {
                console.error('❌ Error force refreshing revenue:', error);
                
                if (typeof showErrorToast === 'function') {
                    showErrorToast('Không thể cập nhật dữ liệu doanh thu: ' + error.message);
                }
            }
        }
          // Function to calculate revenue from finance transactions
        async function calculateRevenueFromTransactions(startDate, endDate) {
            try {
                console.log(`💹 Calculating revenue from transactions from ${startDate.toISOString()} to ${endDate.toISOString()}`);
                
                // Get all transactions in the given date range
                const transactions = await getFinanceTransactionsByDateRange(startDate, endDate);
                console.log(`📑 Total transactions found: ${transactions.length}`);
                
                // Log all transaction IDs for debugging
                console.log('Transaction IDs:', transactions.map(t => t.id || 'unknown').join(', '));
                
                // Filter only income transactions and ensure they are in the correct date range
                const incomeTransactions = transactions.filter(transaction => {
                    // Check if it's an income transaction
                    const isIncome = transaction.type === 'income';
                    
                    // Kiểm tra date cẩn thận
                    let transactionDate = null;
                    if (transaction.date) {
                        if (typeof transaction.date.toDate === 'function') {
                            transactionDate = transaction.date.toDate();
                        } else if (transaction.date instanceof Date) {
                            transactionDate = transaction.date;
                        } else if (typeof transaction.date === 'string' || typeof transaction.date === 'number') {
                            transactionDate = new Date(transaction.date);
                        }
                    }
                    
                    // Check if the transaction date is within range
                    const isInDateRange = transactionDate && 
                                          transactionDate >= startDate && 
                                          transactionDate <= endDate;
                    
                    // Log detailed information for each transaction for debugging
                    console.log(`Transaction ${transaction.id || 'unknown'}: 
                        Type=${transaction.type}, 
                        Amount=${transaction.amount}, 
                        Date=${transactionDate ? transactionDate.toISOString() : 'invalid date'},
                        IsIncome=${isIncome}, 
                        IsInDateRange=${isInDateRange},
                        OrderId=${transaction.orderId || 'none'},
                        Description=${transaction.description || 'no description'}`);
                    
                    // Special check for the specific order we're investigating
                    if (transaction.orderId === 'DS-13LZM5' || 
                        (transaction.description && transaction.description.includes('DS-13LZM5'))) {
                        console.log(`🔍 FOUND DS-13LZM5: Type=${transaction.type}, IsIncome=${isIncome}, IsInDateRange=${isInDateRange}`);
                    }
                    
                    return isIncome && isInDateRange;
                });
                
                console.log(`💰 Number of income transactions: ${incomeTransactions.length}`);
                  // Calculate total revenue
                let totalRevenue = 0;
                incomeTransactions.forEach(transaction => {
                    // Make sure we parse the amount as a number with proper rounding
                    const amount = parseFloat(parseFloat(transaction.amount || 0).toFixed(0));
                    totalRevenue += amount;
                    console.log(`📝 Transaction ${transaction.id || 'unknown'}: ${formatCurrency(amount)}, orderId=${transaction.orderId || 'none'}`);
                    
                    // Highlight our specific order if found
                    if (transaction.orderId === 'DS-13LZM5' || 
                        (transaction.description && transaction.description.includes('DS-13LZM5'))) {
                        console.log(`🎯 DS-13LZM5 IS COUNTED IN REVENUE: ${formatCurrency(amount)}`);
                    }
                });
                
                console.log(`💲 Total revenue: ${formatCurrency(totalRevenue)}`);
                
                return {
                    totalRevenue: totalRevenue,
                    transactions: incomeTransactions
                };
            } catch (error) {
                console.error('❌ Error calculating revenue from transactions:', error);
                return {
                    totalRevenue: 0,
                    transactions: []
                };
            }
        }

        // Utility function for currency formatting
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }        // Make functions globally available
        window.changeMetricsPeriod = changeMetricsPeriod;
        window.refreshRevenueChart = refreshRevenueChart;
        window.refreshTopDishesChart = refreshTopDishesChart;
        window.openPrintReport = openPrintReport;
        window.refreshDashboardData = refreshDashboardData;
        window.performOrdersSync = performOrdersSync;
        window.forceRefreshRevenue = forceRefreshRevenue;
        window.updateRealStats = updateRealStats;
        window.calculateRevenueFromTransactions = calculateRevenueFromTransactions;
        window.userLogout = userLogout;
        window.performLogout = performLogout;
        
        // System Settings Functions
        function showSettings() {
            // Check if vat-manager.js is loaded
            if (typeof getCurrentVatRate !== 'function') {
                console.error('VAT Manager functions not found. Please ensure vat-manager.js is loaded.');
                showErrorToast('Không thể tải chức năng cài đặt thuế. Vui lòng tải lại trang.');
                return;
            }
            
            // Load current VAT rate
            const currentRate = getCurrentVatRate();
            document.getElementById('currentVatRate').value = (currentRate * 100).toFixed(1);
            document.getElementById('vatRate').value = (currentRate * 100).toFixed(1);
            
            // Load VAT history
            loadVatHistory();
            
            // Show modal - try new modal ID first
            try {
                const settingsModalNew = new bootstrap.Modal(document.getElementById('systemSettingsModalNew'));
                settingsModalNew.show();
            } catch (e) {
                console.warn('Error opening new modal:', e);
                // Fallback to old modal
                try {
                    const settingsModalOld = new bootstrap.Modal(document.getElementById('systemSettingsModal'));
                    settingsModalOld.show();
                } catch (e2) {
                    console.error('Error opening any modal:', e2);
                }
            }
        }
        
        function loadVatHistory() {
            const historyTable = document.getElementById('vatHistoryTable');
            if (!historyTable) return;
            
            // Clear existing history
            historyTable.innerHTML = '';
            
            try {
                // Get VAT history from vat-manager.js
                const history = getVatRateHistory();
                
                // Sort by timestamp (newest first)
                const sortedHistory = [...history].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                // Add each history entry to the table
                sortedHistory.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + 
                                         date.toLocaleTimeString('vi-VN');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${(entry.rate * 100).toFixed(1)}%</td>
                        <td>${entry.changedBy || 'Hệ thống'}</td>
                    `;
                    
                    historyTable.appendChild(row);
                });
                
                // If no history, show a message
                if (sortedHistory.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="3" class="text-center">Không có lịch sử thay đổi</td>';
                    historyTable.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading VAT history:', error);
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3" class="text-center text-danger">Lỗi khi tải lịch sử thuế</td>';
                historyTable.appendChild(row);
            }
        }
        
        function saveSystemSettings() {
            try {
                // Get values from form
                const vatRateInput = document.getElementById('vatRate');
                const vatChangeReason = document.getElementById('vatChangeReason');
                
                const newVatRate = parseFloat(vatRateInput.value);
                const reason = vatChangeReason.value.trim() || 'Điều chỉnh thuế suất';
                
                // Validate VAT rate
                if (isNaN(newVatRate) || newVatRate < 0 || newVatRate > 100) {
                    showErrorToast('Thuế suất không hợp lệ. Vui lòng nhập giá trị từ 0 đến 100.');
                    vatRateInput.focus();
                    return;
                }
                
                // Get manager info for recording who made the change
                let changedBy = 'Manager';
                try {
                    const managerInfo = getManagerInfoFromStorage();
                    if (managerInfo && managerInfo.name) {
                        changedBy = managerInfo.name;
                    }
                } catch (error) {
                    console.warn('Could not get manager info:', error);
                }
                
                // Convert percentage to decimal (e.g., 8% -> 0.08)
                const vatRateDecimal = newVatRate / 100;
                
                // Update system settings in localStorage
                updateSystemSettings(vatRateDecimal);
                
                // Record the change in VAT history
                recordVatRateChange(vatRateDecimal, changedBy, reason);
                
                // Show success message
                showSuccessToast(`Đã cập nhật thuế suất thành ${newVatRate.toFixed(1)}%`);
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('systemSettingsModal'));
                if (modal) modal.hide();
                
                // Refresh VAT-related displays
                if (typeof updateVatLabels === 'function') {
                    updateVatLabels();
                }
                
                // Trigger refresh of any displayed data that might use VAT
                setTimeout(() => {
                    if (typeof refreshDashboardData === 'function') {
                        refreshDashboardData();
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showErrorToast('Có lỗi xảy ra khi lưu cài đặt: ' + error.message);
            }
        }
        
        function updateSystemSettings(vatRate) {
            try {
                // Get current settings or create defaults
                const defaultSettings = {
                    business: {
                        vatRate: vatRate,
                        maxTablesPerWaiter: 6,
                        orderTimeout: 30,
                        maxDiscountPercent: 50,
                        inventoryVarianceThreshold: 10
                    },
                    ui: {
                        currency: 'VNĐ',
                        dateFormat: 'DD/MM/YYYY'
                    }
                };
                
                const savedSettings = localStorage.getItem('systemSettings');
                let settings = defaultSettings;
                
                if (savedSettings) {
                    try {
                        const parsed = JSON.parse(savedSettings);
                        settings = {
                            business: { ...defaultSettings.business, ...parsed.business },
                            ui: { ...defaultSettings.ui, ...parsed.ui }
                        };
                    } catch (parseError) {
                        console.warn('Error parsing settings, using defaults:', parseError);
                    }
                }
                
                // Update VAT rate
                settings.business.vatRate = vatRate;
                
                // Save back to localStorage
                localStorage.setItem('systemSettings', JSON.stringify(settings));
                
                // Dispatch event to notify other components
                window.dispatchEvent(new CustomEvent('systemSettingsUpdated', { detail: settings }));
                
                return true;
            } catch (error) {
                console.error('Error updating system settings:', error);
                return false;
            }
        }
        
        // Add function to window scope
        window.showSettings = showSettings;
        window.loadVatHistory = loadVatHistory;
        window.updateSystemSettings = updateSystemSettings;
        
        // Initialize overview when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load overview data by default
            setTimeout(() => {
                if (typeof loadOverviewData === 'function') {
                    loadOverviewData();
                }
                
                // Add event listener for sync orders button
                const syncOrdersBtn = document.getElementById('syncOrdersBtn');
                if (syncOrdersBtn) {
                    syncOrdersBtn.addEventListener('click', performOrdersSync);
                }
                
                // Add event listener for save VAT rate button (old system)
                const saveVatRateBtn = document.getElementById('saveVatRateBtn');
                if (saveVatRateBtn) {
                    saveVatRateBtn.addEventListener('click', saveSystemSettings);
                }
                
                // Add event listener for save tax settings button (new system)
                // Get all save buttons by both ID and class
                const saveButtons = document.querySelectorAll('#saveTaxSettingsBtn, #saveVatRateBtn');
                saveButtons.forEach(button => {
                    // Add event in multiple ways to ensure it works
                    button.addEventListener('click', function(e) {
                        console.log('Tax button clicked via event listener in DOMContentLoaded:', button.id);
                        e.preventDefault();
                        saveTaxSettings();
                        return false;
                    });
                    
                    // Also set direct onclick attribute
                    button.setAttribute('onclick', "saveTaxSettings(); return false;");
                    
                    console.log('Đã gán sự kiện click cho nút', button.id, 'trong DOMContentLoaded');
                });
                
                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 1000);
        });
    </script>
    
    <!-- System Settings Modal -->
    <div class="modal fade" id="systemSettingsModal" tabindex="-1" aria-labelledby="systemSettingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="systemSettingsModalLabel">Cài đặt hệ thống</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="systemSettingsForm">
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Cài đặt thuế</h6>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="vatRate" class="form-label">Thuế VAT (%)</label>
                                    <input type="number" class="form-control" id="vatRate" min="0" max="100" step="0.1" required>
                                    <small class="text-muted">Thuế sẽ áp dụng với đơn hàng mới.</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Thuế hiện tại</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control bg-light" id="currentVatRate" disabled>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="vatChangeReason" class="form-label">Lý do thay đổi</label>
                            <textarea class="form-control" id="vatChangeReason" rows="2" placeholder="Nhập lý do thay đổi thuế"></textarea>
                        </div>
                        
                        <!-- VAT History Section -->
                        <div class="mt-4">
                            <h6 class="border-bottom pb-2">Lịch sử thay đổi thuế</h6>
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Thời gian</th>
                                            <th>Thuế</th>
                                            <th>Người thay đổi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vatHistoryTable">
                                        <!-- History will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="saveVatRateBtn" onclick="saveTaxSettings(); return false;">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Settings Modal (New Version) -->
    <div class="modal fade" id="systemSettingsModalNew" tabindex="-1" aria-labelledby="systemSettingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="systemSettingsModalLabel">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings me-2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        Cài đặt hệ thống
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="settings-section mb-4">
                        <h6 class="settings-section-title mb-3">Cài đặt thuế</h6>
                        <div class="card">
                            <div class="card-body">
                                <form id="taxSettingsForm">
                                    <div class="mb-3">
                                        <label for="taxRateInput" class="form-label">Thuế suất (%)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="taxRateInput" min="0" max="100" step="0.1" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <div class="form-text">Thuế suất mới sẽ được áp dụng cho đơn hàng tạo sau thời điểm cập nhật.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="taxEffectiveDate" class="form-label">Ngày áp dụng</label>
                                        <input type="datetime-local" class="form-control" id="taxEffectiveDate" required>
                                    </div>
                                    <div class="tax-history-container mt-4">
                                        <h6 class="mb-2">Lịch sử thuế suất</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Thuế suất (%)</th>
                                                        <th>Ngày áp dụng</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="taxHistoryTableBody">
                                                    <!-- Tax history will be inserted here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Các trường ẩn cho tương thích với hệ thống cũ -->
                                    <input type="hidden" id="currentVatRate">
                                    <input type="hidden" id="vatRate">
                                    <input type="hidden" id="vatChangeReason" value="Cập nhật thuế suất">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="saveTaxSettingsBtn" onclick="saveTaxSettings(); return false;">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fix cho nút lưu thuế - gọi trực tiếp khi trang đã load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const saveTaxBtn = document.getElementById('saveTaxSettingsBtn');
                if (saveTaxBtn) {
                    console.log('Tìm thấy nút saveTaxSettingsBtn, gắn sự kiện');
                    saveTaxBtn.onclick = function(e) {
                        e.preventDefault();
                        console.log('Nút saveTaxSettingsBtn được nhấn');
                        saveTaxSettings();
                    };
                } else {
                    console.warn('Không tìm thấy nút saveTaxSettingsBtn');
                }
            }, 2000);
        });
        
        // Tax Settings Functions
        function loadTaxSettings() {
            try {
                // Trước tiên thử lấy từ hệ thống cũ nếu có
                let currentRate = 10.0;  // Giá trị mặc định
                let existingHistory = [];
                let useOldSystem = false;
                
                // Kiểm tra xem có hệ thống thuế cũ (vatManager) không
                if (typeof window.vatManager !== 'undefined' && 
                    typeof window.vatManager.getCurrentVatRate === 'function') {
                    try {
                        currentRate = window.vatManager.getCurrentVatRate() * 100;  // Chuyển từ định dạng 0.1 sang 10%
                        useOldSystem = true;
                        console.log('Đã tìm thấy hệ thống thuế cũ (vatManager), thuế suất hiện tại:', currentRate);
                    } catch(e) {
                        console.warn('Không thể lấy thuế suất từ hệ thống cũ (vatManager):', e);
                    }
                }
                
                // Nếu không có hệ thống cũ, lấy từ localStorage
                if (!useOldSystem) {
                    const taxHistory = JSON.parse(localStorage.getItem('taxHistory')) || [];
                    existingHistory = taxHistory;
                    
                    if (taxHistory.length > 0) {
                        // Sort by date in descending order
                        taxHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        // Set current tax rate
                        const currentTax = taxHistory[0];
                        currentRate = currentTax.rate;
                    }
                }
                
                // Cập nhật giao diện
                document.getElementById('taxRateInput').value = currentRate.toFixed(1);
                
                // Đồng bộ với hệ thống cũ
                document.getElementById('currentVatRate').value = (currentRate / 100).toFixed(3);
                document.getElementById('vatRate').value = (currentRate / 100).toFixed(3);
                
                // Set default effective date to now
                const now = new Date();
                const localDatetime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 16);
                document.getElementById('taxEffectiveDate').value = localDatetime;
                
                // Populate tax history table
                renderTaxHistory(existingHistory);
                
                // Nếu không có lịch sử, tạo một entry ban đầu
                if (existingHistory.length === 0) {
                    console.log('Không có lịch sử thuế, tạo entry ban đầu với thuế suất:', currentRate);
                    // Tạo entry ban đầu với thuế suất đã lấy được (từ hệ thống cũ hoặc mặc định)
                    const initialEntry = {
                        rate: currentRate,
                        date: new Date().toISOString()
                    };
                    
                    // Lưu vào localStorage
                    localStorage.setItem('taxHistory', JSON.stringify([initialEntry]));
                    
                    // Cập nhật giao diện
                    renderTaxHistory([initialEntry]);
                }
            } catch (error) {
                console.error('Error loading tax settings:', error);
                showToast('Không thể tải cài đặt thuế. Sử dụng giá trị mặc định.', 'error');
                
                // Set default values
                document.getElementById('taxRateInput').value = "10.0";
                document.getElementById('currentVatRate').value = "0.10";
                document.getElementById('vatRate').value = "0.10";
                
                const now = new Date();
                const localDatetime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 16);
                document.getElementById('taxEffectiveDate').value = localDatetime;
            }
        }
        
        function renderTaxHistory(taxHistory) {
            const tableBody = document.getElementById('taxHistoryTableBody');
            tableBody.innerHTML = '';
            
            taxHistory.forEach(entry => {
                const row = document.createElement('tr');
                
                const rateCell = document.createElement('td');
                rateCell.textContent = entry.rate + '%';
                
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDateTime(entry.date);
                
                row.appendChild(rateCell);
                row.appendChild(dateCell);
                
                tableBody.appendChild(row);
            });
        }
        
        function saveTaxSettings() {
            try {
                console.log('saveTaxSettings function called');
                // Try to find form fields in either modal
                let taxRateInput = document.getElementById('taxRateInput'); // New modal
                let taxEffectiveDateInput = document.getElementById('taxEffectiveDate'); // New modal
                
                // If not found in new modal, try old modal fields
                if (!taxRateInput) {
                    taxRateInput = document.getElementById('vatRate'); // Old modal
                    console.log('Using vatRate field from old modal');
                }
                
                // For old modal, create a fake effective date (current time)
                if (!taxEffectiveDateInput) {
                    console.log('No effective date field found, using current time');
                    const now = new Date();
                    taxEffectiveDateInput = {
                        value: now.toISOString().slice(0, 16) // Format for datetime-local
                    };
                }
                
                if (!taxRateInput) {
                    console.error('No tax rate input field found!');
                    showToast('Không tìm thấy trường nhập thuế suất', 'error');
                    return;
                }
                
                console.log('Tax rate input value:', taxRateInput.value);
                
                // Validate inputs
                const taxRate = parseFloat(taxRateInput.value);
                console.log('Parsed tax rate:', taxRate);
                
                if (isNaN(taxRate) || taxRate < 0 || taxRate > 100) {
                    showToast('Thuế suất phải là số từ 0 đến 100', 'error');
                    return;
                }
                
                const effectiveDate = new Date(taxEffectiveDateInput.value);
                console.log('Parsed effective date:', effectiveDate);
                
                if (isNaN(effectiveDate.getTime())) {
                    console.log('Invalid date, using current time');
                    effectiveDate = new Date(); // Use current time if date is invalid
                }
                
                // Create new tax entry
                const newTaxEntry = {
                    rate: taxRate,
                    date: effectiveDate.toISOString()
                };
                
                // Get existing tax history
                let taxHistory = JSON.parse(localStorage.getItem('taxHistory')) || [];
                
                // Add new entry
                taxHistory.push(newTaxEntry);
                
                // Sort by date in descending order
                taxHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Save to localStorage
                localStorage.setItem('taxHistory', JSON.stringify(taxHistory));
                
                // Update UI
                renderTaxHistory(taxHistory);
                
                // Cập nhật giá trị cho hệ thống cũ
                const vatRateDecimal = taxRate / 100;
                document.getElementById('currentVatRate').value = vatRateDecimal.toFixed(3);
                document.getElementById('vatRate').value = vatRateDecimal.toFixed(3);
                
                // Đồng bộ với hệ thống cũ nếu có
                try {
                    if (typeof updateSystemSettings === 'function') {
                        updateSystemSettings(vatRateDecimal);
                        console.log('Đã đồng bộ thuế suất với hệ thống cũ:', vatRateDecimal);
                    }
                    
                    if (typeof recordVatRateChange === 'function') {
                        const reason = document.getElementById('vatChangeReason').value || 'Cập nhật thuế suất';
                        const managerInfo = getManagerInfoFromStorage();
                        const changedBy = managerInfo && managerInfo.name ? managerInfo.name : 'Quản lý';
                        
                        recordVatRateChange(vatRateDecimal, changedBy, reason);
                        console.log('Đã ghi nhận thay đổi thuế suất trong hệ thống cũ');
                    }
                } catch (syncError) {
                    console.warn('Không thể đồng bộ với hệ thống cũ:', syncError);
                    // Tiếp tục xử lý bình thường ngay cả khi đồng bộ thất bại
                }
                
                // Show success message
                showToast('Cài đặt thuế đã được cập nhật thành công thành ' + taxRate.toFixed(1) + '%', 'success');
                
                // Close modal - try both modal IDs to ensure compatibility
                try {
                    const modalNew = bootstrap.Modal.getInstance(document.getElementById('systemSettingsModalNew'));
                    if (modalNew) {
                        modalNew.hide();
                    }
                } catch (e) {
                    console.warn('Error closing new modal:', e);
                }
                
                try {
                    const modalOld = bootstrap.Modal.getInstance(document.getElementById('systemSettingsModal'));
                    if (modalOld) {
                        modalOld.hide();
                    }
                } catch (e) {
                    console.warn('Error closing old modal:', e);
                }
                
                // Trigger cập nhật các thành phần khác nếu cần
                if (typeof updateVatLabels === 'function') {
                    try {
                        updateVatLabels();
                    } catch (e) {
                        console.warn('Không thể cập nhật nhãn thuế:', e);
                    }
                }
                
                // Dispatch custom event to notify other components about tax rate change
                window.dispatchEvent(new CustomEvent('taxRateUpdated', { 
                    detail: { 
                        rate: taxRate,
                        rateDecimal: vatRateDecimal,
                        effectiveDate: effectiveDate.toISOString()
                    } 
                }));
                
                // Force refresh VAT manager cache
                if (typeof window.vatManager !== 'undefined' && typeof window.vatManager.refreshCache === 'function') {
                    window.vatManager.refreshCache();
                }
                
                console.log('Tax rate update completed, rate:', taxRate + '%', 'effective:', effectiveDate.toISOString());
            } catch (error) {
                console.error('Error saving tax settings:', error);
                showToast('Không thể lưu cài đặt thuế', 'error');
            }
        }
        
        // Make saveTaxSettings globally available
        window.saveTaxSettings = saveTaxSettings;
        
        function getCurrentTaxRate(date = new Date()) {
            try {
                // Avoid calling getCurrentVatRate to prevent infinite recursion
                // Instead, access original vat-manager.js function directly if it exists
                if (typeof window.vatManager !== 'undefined' && 
                    typeof window.vatManager.getCurrentVatRate === 'function') {
                    try {
                        // Chuyển đổi từ định dạng decimal (0.1) sang phần trăm (10.0)
                        const oldSystemRate = window.vatManager.getCurrentVatRate() * 100;
                        console.log('Lấy thuế suất từ hệ thống cũ (vatManager):', oldSystemRate);
                        return oldSystemRate;
                    } catch (e) {
                        console.warn('Không thể lấy thuế suất từ vatManager:', e);
                        // Tiếp tục với hệ thống mới
                    }
                }
                
                // Nếu không có hệ thống cũ, lấy từ localStorage
                const taxHistory = JSON.parse(localStorage.getItem('taxHistory')) || [];
                
                if (taxHistory.length === 0) {
                    return 10.0; // Default 10% if no tax history
                }
                
                // Sort by date in descending order
                taxHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Find the applicable tax rate for the given date
                const targetDate = new Date(date);
                
                for (const entry of taxHistory) {
                    const entryDate = new Date(entry.date);
                    if (entryDate <= targetDate) {
                        return parseFloat(entry.rate);
                    }
                }
                
                // If no applicable entry found, return the oldest tax rate
                return parseFloat(taxHistory[taxHistory.length - 1].rate);
            } catch (error) {
                console.error('Error getting current tax rate:', error);
                return 10.0; // Default 10% on error
            }
        }
        
        // Hàm tương thích với hệ thống cũ để lấy thuế suất dưới dạng decimal
        function getCurrentVatRate() {
            try {
                // Avoid calling getCurrentTaxRate to prevent infinite recursion
                // Access tax history directly from localStorage
                const taxHistory = JSON.parse(localStorage.getItem('taxHistory')) || [];
                
                if (taxHistory.length === 0) {
                    return 0.10; // Default 10% (as decimal) if no tax history
                }
                
                // Sort by date in descending order
                taxHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get the most recent tax rate and convert to decimal
                const currentRate = parseFloat(taxHistory[0].rate) / 100;
                return currentRate;
            } catch (error) {
                console.error('Error in getCurrentVatRate:', error);
                return 0.10; // Default 10% (as decimal) on error
            }
        }
        
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }
        
        function setupTaxSettingsEventListeners() {
            // Gán sự kiện cho tất cả các nút lưu (để đảm bảo chúng đều hoạt động)
            const allSaveButtons = document.querySelectorAll('#saveTaxSettingsBtn, #saveVatRateBtn');
            
            allSaveButtons.forEach(button => {
                // Thêm cả hai cách gán sự kiện để đảm bảo hoạt động
                button.addEventListener('click', function(e) {
                    console.log('Button clicked via addEventListener:', e.target.id);
                    saveTaxSettings();
                    return false;
                });
                
                // Thêm trực tiếp onclick attribute
                button.setAttribute('onclick', "saveTaxSettings(); return false;");
                
                console.log('Đã gán sự kiện click cho nút:', button.id);
            });
            
            if (allSaveButtons.length === 0) {
                console.error('Không tìm thấy nút lưu với ID saveTaxSettingsBtn hoặc saveVatRateBtn');
            } else {
                console.log('Đã gán sự kiện cho', allSaveButtons.length, 'nút lưu');
            }
        }
        
        // Helper functions cho hệ thống thuế
        function getTaxHistory() {
            return JSON.parse(localStorage.getItem('taxHistory')) || [];
        }
        
        function updateTaxRate(rate, effectiveDate, changedBy = 'Manager', reason = 'Cập nhật thuế suất') {
            try {
                // Tạo entry mới
                const newEntry = {
                    rate: parseFloat(rate),
                    date: effectiveDate instanceof Date ? effectiveDate.toISOString() : effectiveDate,
                    changedBy: changedBy,
                    reason: reason
                };
                
                // Cập nhật lịch sử
                const history = getTaxHistory();
                history.push(newEntry);
                history.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Lưu vào localStorage
                localStorage.setItem('taxHistory', JSON.stringify(history));
                
                return true;
            } catch (error) {
                console.error('Error updating tax rate:', error);
                return false;
            }
        }
        
        // Khởi tạo cho hệ thống thuế mới
        function initTaxSystem() {
            const history = getTaxHistory();
            if (history.length === 0) {
                // Khởi tạo với thuế suất mặc định hoặc từ hệ thống cũ nếu có
                let initialRate = 10.0;
                
                // Kiểm tra hệ thống cũ qua vatManager object
                if (typeof window.vatManager !== 'undefined' && 
                    typeof window.vatManager.getCurrentVatRate === 'function') {
                    try {
                        initialRate = window.vatManager.getCurrentVatRate() * 100;
                        console.log('Sử dụng thuế suất từ vatManager:', initialRate);
                    } catch(e) {
                        console.warn('Không thể lấy thuế suất từ vatManager:', e);
                    }
                } else {
                    console.log('Sử dụng thuế suất mặc định:', initialRate);
                }
                
                // Tạo entry đầu tiên
                updateTaxRate(initialRate, new Date(), 'System', 'Khởi tạo');
                console.log('Đã khởi tạo hệ thống thuế mới với thuế suất:', initialRate);
            }
        }
        
        // Hàm tương thích với hệ thống cũ: lấy lịch sử thuế
        function getVatRateHistory() {
            try {
                const history = getTaxHistory();
                // Chuyển đổi sang định dạng của hệ thống cũ
                return history.map(item => ({
                    timestamp: item.date,
                    rate: parseFloat(item.rate) / 100, // Chuyển từ % sang decimal
                    changedBy: item.changedBy || 'System',
                    reason: item.reason || 'Cập nhật thuế suất'
                }));
            } catch (error) {
                console.error('Error getting VAT history:', error);
                return [];
            }
        }
        
        // Override showSettings function
        window.showSettings = function() {
            // Initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Đảm bảo hệ thống thuế đã được khởi tạo
            initTaxSystem();
            
            // Load current tax settings
            loadTaxSettings();
            
            // Setup event listeners for tax settings
            setupTaxSettingsEventListeners();
            
            // Show the modal - use the new modal with the correct form fields
            const modal = new bootstrap.Modal(document.getElementById('systemSettingsModalNew'));
            modal.show();
            
            // Thêm sự kiện click trực tiếp cho nút lưu để đảm bảo nó hoạt động
            setTimeout(() => {
                console.log('Kiểm tra và gắn sự kiện cho các nút lưu');
                
                // Tìm tất cả các nút lưu trong modal mới
                const saveButtons = document.querySelectorAll('#systemSettingsModalNew button.btn-primary');
                console.log(`Tìm thấy ${saveButtons.length} nút lưu trong modal mới`);
                
                // Gắn sự kiện cho tất cả các nút lưu
                saveButtons.forEach(button => {
                    // Xóa các sự kiện cũ để tránh trùng lặp
                    button.removeEventListener('click', saveTaxSettings);
                    
                    // Gắn sự kiện mới
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        console.log('Nút lưu được nhấn:', button.id || 'không có ID');
                        saveTaxSettings();
                    });
                    
                    console.log('Đã gắn sự kiện click cho nút:', button.id || 'không có ID');
                });
            }, 500); // Đợi một chút để đảm bảo modal đã được render hoàn toàn
        };
        
        // Make tax functions available globally
        window.taxSystem = {
            getCurrentTaxRate,
            getCurrentVatRate,
            getTaxHistory,
            updateTaxRate,
            getVatRateHistory
        };
        
        // For compatibility, also add to window directly
        // But avoid recursive calls by ensuring we don't overwrite 
        // any functions from vat-manager.js
        if (typeof window.vatManager === 'undefined') {
            window.getCurrentVatRate = getCurrentVatRate;
            window.getVatRateHistory = getVatRateHistory;
        }
    </script>
</body>
</html>