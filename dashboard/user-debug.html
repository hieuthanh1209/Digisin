<!DOCTYPE html>
<html lang="vi">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ kiểm tra thông tin người dùng</title>
    <link rel="icon" href="../assets/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .badge-success {
            background-color: #28a745;
        }
        .badge-danger {
            background-color: #dc3545;
        }
        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Công cụ kiểm tra thông tin người dùng</h1>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Thông tin đăng nhập</h5>
            </div>
            <div class="card-body">
                <div class="mb-3" id="authStatus">
                    <span class="badge bg-warning">Đang kiểm tra...</span>
                </div>
                
                <h6>Chi tiết người dùng Firebase Auth</h6>
                <pre id="authUserData">Đang tải dữ liệu...</pre>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Thông tin Firestore</h5>
            </div>
            <div class="card-body">
                <div class="mb-3" id="firestoreStatus">
                    <span class="badge bg-warning">Đang kiểm tra...</span>
                </div>
                
                <h6>Chi tiết người dùng Firestore</h6>
                <pre id="firestoreUserData">Đang tải dữ liệu...</pre>
            </div>
        </div>
        
        <div class="d-flex justify-content-between">
            <a href="waiter-dashboard.html" class="btn btn-secondary">Quay lại Dashboard</a>
            <button id="refreshBtn" class="btn btn-primary">Làm mới dữ liệu</button>
        </div>
    </div>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"></script>
    <!-- Firebase Firestore -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import firebaseConfig from "../config/firebase-config.js";
        
        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM elements
        const authStatus = document.getElementById('authStatus');
        const authUserData = document.getElementById('authUserData');
        const firestoreStatus = document.getElementById('firestoreStatus');
        const firestoreUserData = document.getElementById('firestoreUserData');
        const refreshBtn = document.getElementById('refreshBtn');
        
        // Làm mới dữ liệu
        refreshBtn.addEventListener('click', checkUserData);
        
        // Hàm kiểm tra thông tin người dùng
        function checkUserData() {
            authStatus.innerHTML = '<span class="badge bg-warning">Đang kiểm tra...</span>';
            firestoreStatus.innerHTML = '<span class="badge bg-warning">Đang kiểm tra...</span>';
            authUserData.textContent = 'Đang tải dữ liệu...';
            firestoreUserData.textContent = 'Đang tải dữ liệu...';
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Người dùng đã đăng nhập
                    authStatus.innerHTML = '<span class="badge bg-success">Đã đăng nhập</span>';
                    
                    // Hiển thị thông tin Firebase Auth (đã loại bỏ dữ liệu nhạy cảm)
                    const safeAuthUserData = {
                        uid: user.uid,
                        email: user.email?.substring(0, 3) + "..." + user.email?.split('@')[1],
                        displayName: user.displayName || "Không có",
                        emailVerified: user.emailVerified,
                        providerId: user.providerId,
                        lastLoginAt: new Date(parseInt(user.metadata.lastLoginAt)).toLocaleString(),
                        createdAt: new Date(parseInt(user.metadata.createdAt)).toLocaleString()
                    };
                    
                    authUserData.textContent = JSON.stringify(safeAuthUserData, null, 2);
                    
                    try {
                        // Lấy thông tin từ Firestore
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        
                        if (userDoc.exists()) {
                            firestoreStatus.innerHTML = '<span class="badge bg-success">Dữ liệu hợp lệ</span>';
                            
                            const userData = userDoc.data();
                            
                            // Chuẩn bị dữ liệu để hiển thị (đã loại bỏ thông tin nhạy cảm)
                            const safeUserData = {
                                displayName: userData.displayName || "Không có",
                                name: userData.name || "Không có",
                                role: userData.role,
                                phoneNumber: userData.phoneNumber ? userData.phoneNumber.substring(0, 3) + "..." + userData.phoneNumber.substring(userData.phoneNumber.length - 2) : "Không có",
                                createdAt: userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleString() : "Không có",
                                lastLogin: userData.lastLogin ? new Date(userData.lastLogin.toDate()).toLocaleString() : "Không có",
                                hasAdditionalFields: Object.keys(userData).filter(key => !['displayName', 'name', 'role', 'phoneNumber', 'createdAt', 'lastLogin'].includes(key))
                            };
                            
                            firestoreUserData.textContent = JSON.stringify(safeUserData, null, 2);
                        } else {
                            firestoreStatus.innerHTML = '<span class="badge bg-danger">Không tìm thấy dữ liệu</span>';
                            firestoreUserData.textContent = "Không tìm thấy thông tin người dùng trong Firestore";
                        }
                    } catch (error) {
                        firestoreStatus.innerHTML = '<span class="badge bg-danger">Lỗi truy vấn</span>';
                        firestoreUserData.textContent = `Lỗi khi truy vấn Firestore: ${error.message}`;
                        console.error("Lỗi khi truy vấn Firestore:", error);
                    }
                } else {
                    // Người dùng chưa đăng nhập
                    authStatus.innerHTML = '<span class="badge bg-danger">Chưa đăng nhập</span>';
                    authUserData.textContent = "Không có thông tin người dùng (chưa đăng nhập)";
                    
                    firestoreStatus.innerHTML = '<span class="badge bg-danger">Không có dữ liệu</span>';
                    firestoreUserData.textContent = "Không có thông tin người dùng trong Firestore (chưa đăng nhập)";
                }
            });
        }
        
        // Kiểm tra ngay khi tải trang
        checkUserData();
    </script>
</body>
</html>
