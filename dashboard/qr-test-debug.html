<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR Code trong H√≥a ƒë∆°n</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .invoice-preview { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin: 15px 0; 
            font-family: 'Courier New', monospace; 
            font-size: 14px;
            max-width: 400px;
        }
        button { padding: 10px 20px; margin: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>üîç Test QR Code trong H√≥a ƒë∆°n</h1>
    
    <div class="test-section">
        <h3>Test 1: Ki·ªÉm tra QRCode Library</h3>
        <button onclick="testQRLibrary()">Test QR Library</button>
        <div id="qr-lib-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 2: T·∫°o QR Code cho Order</h3>
        <button onclick="testOrderQR()">T·∫°o QR cho Order Test</button>
        <div id="order-qr-result"></div>
        <div id="qr-display"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 3: Test In H√≥a ƒë∆°n v·ªõi QR</h3>
        <button onclick="testPrintInvoice()">Test In H√≥a ƒë∆°n</button>
        <div id="print-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 4: PayOS QR Thanh to√°n (M·ªöI)</h3>
        <button onclick="testPayOSPaymentQR()">Test PayOS QR Thanh to√°n</button>
        <div id="payos-qr-result"></div>
        <div id="payos-qr-display"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 5: In H√≥a ƒë∆°n v·ªõi PayOS QR Thanh to√°n</h3>
        <button onclick="testPrintPayOSInvoice()">Test In H√≥a ƒë∆°n PayOS</button>
        <div id="payos-print-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Preview H√≥a ƒë∆°n</h3>
        <div class="invoice-preview" id="invoice-preview">
            <!-- H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>
    </div>

    <script>
        // Mock data
        const VAT_RATE = 0.08;
        const testOrder = {
            id: 'HD001',
            table: 'B√†n 5',
            orderTime: new Date(),
            items: [
                { name: 'Ph·ªü b√≤ t√°i', quantity: 2, price: 60000 },
                { name: 'Tr√† ƒë√°', quantity: 2, price: 5000 }
            ],
            status: 'ready',
            total: 130000
        };
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + '‚Ç´';
        }
        
        // Test 1: Ki·ªÉm tra QR Library
        function testQRLibrary() {
            const resultDiv = document.getElementById('qr-lib-result');
            
            if (typeof QRCode === 'undefined') {
                resultDiv.innerHTML = '<span class="error">‚ùå QRCode library kh√¥ng ƒë∆∞·ª£c t·∫£i</span>';
                return;
            }
            
            resultDiv.innerHTML = '<span class="success">‚úÖ QRCode library ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng</span>';
            console.log('QRCode object:', QRCode);
        }
        
        // Test 2: T·∫°o QR Code
        async function testOrderQR() {
            const resultDiv = document.getElementById('order-qr-result');
            const displayDiv = document.getElementById('qr-display');
            
            try {
                resultDiv.innerHTML = '‚è≥ ƒêang t·∫°o QR code...';
                
                const qrData = JSON.stringify({
                    type: 'ORDER_SUMMARY',
                    orderId: testOrder.id,
                    table: testOrder.table,
                    amount: testOrder.total,
                    items: testOrder.items.length,
                    restaurant: 'Nh√† h√†ng ABC'
                });
                
                const qrCodeDataUrl = await QRCode.toDataURL(qrData, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                
                resultDiv.innerHTML = '<span class="success">‚úÖ QR Code t·∫°o th√†nh c√¥ng!</span>';
                displayDiv.innerHTML = `<img src="${qrCodeDataUrl}" style="max-width: 200px; border: 1px solid #ccc;">`;
                
                // L∆∞u QR code v√†o order
                testOrder.qrCodeData = {
                    dataUrl: qrCodeDataUrl,
                    data: qrData
                };
                
                console.log('QR Code created:', qrCodeDataUrl.substring(0, 50) + '...');
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå L·ªói t·∫°o QR: ${error.message}</span>`;
                console.error('QR Error:', error);
            }
        }
        
        // Test 3: Test In h√≥a ƒë∆°n
        function testPrintInvoice() {
            const resultDiv = document.getElementById('print-result');
            
            try {
                const invoiceHtml = generateTestInvoice(testOrder);
                
                // Hi·ªÉn th·ªã preview
                document.getElementById('invoice-preview').innerHTML = invoiceHtml;
                
                // M·ªü c·ª≠a s·ªï in
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Test H√≥a ƒë∆°n ${testOrder.id}</title>
                        <style>
                            body { margin: 0; padding: 15px; font-family: 'Courier New', monospace; }
                            @media print {
                                body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                                img { max-width: 100% !important; height: auto !important; }
                            }
                        </style>
                    </head>
                    <body>${invoiceHtml}</body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                resultDiv.innerHTML = '<span class="success">‚úÖ C·ª≠a s·ªï in ƒë√£ m·ªü</span>';
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå L·ªói in h√≥a ƒë∆°n: ${error.message}</span>`;
                console.error('Print Error:', error);
            }
        }
        
        function generateTestInvoice(order) {
            const subtotal = order.total;
            const taxAmount = subtotal * VAT_RATE;
            const finalTotal = subtotal + taxAmount;
            const hasQRCode = order.qrCodeData && order.qrCodeData.dataUrl;
            
            return `
                <div style="max-width: 400px; margin: 0 auto; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4;">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 18px; font-weight: bold;">NH√Ä H√ÄNG ABC</h2>
                        <p style="margin: 5px 0 0 0; font-size: 12px;">123 ƒê∆∞·ªùng XYZ, Qu·∫≠n 1, TP.HCM</p>
                        <p style="margin: 2px 0 0 0; font-size: 12px;">Tel: 028.1234.5678</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>H√≥a ƒë∆°n:</strong></span>
                            <span>${order.id}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>B√†n:</strong></span>
                            <span>${order.table}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>Ng√†y:</strong></span>
                            <span>${new Date().toLocaleDateString('vi-VN')}</span>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin-bottom: 15px;">
                        ${order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span>${item.quantity}x ${item.name}</span>
                                <span>${formatCurrency(item.quantity * item.price)}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="border-top: 2px solid #000; padding-top: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 16px; font-weight: bold;">
                            <span>TH√ÄNH TI·ªÄN:</span>
                            <span>${formatCurrency(finalTotal)}</span>
                        </div>
                    </div>
                    
                    ${hasQRCode ? `
                        <div style="text-align: center; border-top: 1px dashed #000; padding-top: 15px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold;">M√É QR TH√îNG TIN ƒê·ªåN H√ÄNG</p>
                            <img src="${order.qrCodeData.dataUrl}" 
                                 style="width: 120px; height: 120px; margin: 10px auto; display: block;" 
                                 alt="QR Code th√¥ng tin ƒë∆°n h√†ng"
                                 onload="console.log('‚úÖ QR Image loaded successfully')"
                                 onerror="console.error('‚ùå QR Image failed to load')">
                            <p style="margin: 10px 0 5px 0; font-size: 10px; color: #666;">Qu√©t m√£ QR ƒë·ªÉ xem chi ti·∫øt</p>
                        </div>
                    ` : `
                        <div style="text-align: center; border-top: 1px dashed #000; padding-top: 15px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold; color: #999;">KH√îNG C√ì M√É QR</p>
                            <div style="width: 120px; height: 120px; margin: 10px auto; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                <span style="color: #999; font-size: 10px;">No QR</span>
                            </div>
                        </div>
                    `}
                    
                    <div style="text-align: center; font-size: 12px; border-top: 1px dashed #000; padding-top: 10px;">
                        <p style="margin: 0 0 5px 0; color: #ff6b35;"><strong>H√ìA ƒê∆†N TEST</strong></p>
                        <p style="margin: 0; color: #666;">ƒê√¢y l√† h√≥a ƒë∆°n test</p>
                    </div>
                </div>
            `;
        }
        
        // Auto run tests on load
        window.addEventListener('load', function() {
            console.log('üöÄ Test page loaded');
            testQRLibrary();
        });
        
        // === NEW: PayOS Payment QR Tests ===
        
        // Generate PayOS QR URL (from cashier-script.js)
        function getPayOSQRUrl(orderId, table, amount) {
            const addInfo = `TT ${orderId} ${table}`.replace(/\s+/g, '+');
            const qrUrl = `https://img.vietqr.io/image/970452-10142505304746708-payos.jpg?addInfo=${addInfo}&amount=${amount}`;
            console.log('Generated PayOS QR URL:', qrUrl);
            return qrUrl;
        }
        
        // Test 4: PayOS Payment QR
        function testPayOSPaymentQR() {
            const resultDiv = document.getElementById('payos-qr-result');
            const displayDiv = document.getElementById('payos-qr-display');
            
            try {
                resultDiv.innerHTML = '‚è≥ ƒêang t·∫°o PayOS QR thanh to√°n...';
                
                const subtotal = testOrder.total;
                const taxAmount = subtotal * VAT_RATE;
                const finalTotal = Math.round(subtotal + taxAmount);
                
                const payosQRUrl = getPayOSQRUrl(testOrder.id, testOrder.table, finalTotal);
                
                // Add PayOS QR data to order
                testOrder.paymentQRData = {
                    dataUrl: payosQRUrl,
                    isVietQR: true,
                    isPaymentQR: true,
                    amount: finalTotal,
                    qrType: 'PAYOS_PAYMENT'
                };
                
                resultDiv.innerHTML = '<span class="success">‚úÖ PayOS QR thanh to√°n t·∫°o th√†nh c√¥ng!</span>';
                displayDiv.innerHTML = `
                    <div style="text-align: center;">
                        <p><strong>üè¶ PayOS VietQR - Thanh to√°n ${formatCurrency(finalTotal)}</strong></p>
                        <img src="${payosQRUrl}" style="max-width: 200px; border: 1px solid #28a745; border-radius: 8px;">
                        <p style="font-size: 12px; color: #666;">üì± Qu√©t b·∫±ng app ng√¢n h√†ng ƒë·ªÉ thanh to√°n</p>
                    </div>
                `;
                
                console.log('PayOS QR URL:', payosQRUrl);
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå L·ªói t·∫°o PayOS QR: ${error.message}</span>`;
                console.error('PayOS QR Error:', error);
            }
        }
        
        // Test 5: Print PayOS Invoice
        function testPrintPayOSInvoice() {
            const resultDiv = document.getElementById('payos-print-result');
            
            try {
                // Ensure we have PayOS QR data
                if (!testOrder.paymentQRData) {
                    testPayOSPaymentQR(); // Generate it first
                }
                
                const invoiceHtml = generatePayOSInvoice(testOrder);
                
                // Update preview
                document.getElementById('invoice-preview').innerHTML = invoiceHtml;
                
                // Open print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Test PayOS H√≥a ƒë∆°n ${testOrder.id}</title>
                        <style>
                            body { margin: 0; padding: 15px; font-family: 'Courier New', monospace; }
                            @media print {
                                body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                                img { max-width: 100% !important; height: auto !important; }
                            }
                        </style>
                    </head>
                    <body>${invoiceHtml}</body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                resultDiv.innerHTML = '<span class="success">‚úÖ PayOS H√≥a ƒë∆°n thanh to√°n ƒë√£ m·ªü</span>';
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå L·ªói in PayOS h√≥a ƒë∆°n: ${error.message}</span>`;
                console.error('PayOS Print Error:', error);
            }
        }
        
        function generatePayOSInvoice(order) {
            const subtotal = order.total;
            const taxAmount = subtotal * VAT_RATE;
            const finalTotal = Math.round(subtotal + taxAmount);
            const hasPayOSQR = order.paymentQRData && order.paymentQRData.dataUrl;
            
            return `
                <div style="max-width: 400px; margin: 0 auto; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4;">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 18px; font-weight: bold;">NH√Ä H√ÄNG ABC</h2>
                        <p style="margin: 5px 0 0 0; font-size: 12px;">123 ƒê∆∞·ªùng XYZ, Qu·∫≠n 1, TP.HCM</p>
                        <p style="margin: 2px 0 0 0; font-size: 12px;">Tel: 028.1234.5678</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>H√≥a ƒë∆°n:</strong></span>
                            <span>${order.id}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>B√†n:</strong></span>
                            <span>${order.table}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>Tr·∫°ng th√°i:</strong></span>
                            <span style="color: #ff6b35; font-weight: bold;">CH∆ØA THANH TO√ÅN</span>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin-bottom: 15px;">
                        ${order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span>${item.quantity}x ${item.name}</span>
                                <span>${formatCurrency(item.quantity * item.price)}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="border-top: 2px solid #000; padding-top: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 16px; font-weight: bold;">
                            <span>TH√ÄNH TI·ªÄN:</span>
                            <span>${formatCurrency(finalTotal)}</span>
                        </div>
                    </div>
                    
                    ${hasPayOSQR ? `
                        <div style="text-align: center; border-top: 1px dashed #000; padding-top: 15px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold; color: #28a745;">üè¶ M√É QR THANH TO√ÅN PAYOS</p>
                            <img src="${order.paymentQRData.dataUrl}" 
                                 style="width: 140px; height: 140px; margin: 10px auto; display: block; border: 1px solid #ddd; border-radius: 8px;" 
                                 alt="PayOS QR Code thanh to√°n"
                                 onload="console.log('‚úÖ PayOS QR loaded in invoice')"
                                 onerror="console.error('‚ùå PayOS QR failed to load in invoice')">
                            <p style="margin: 10px 0 5px 0; font-size: 10px; color: #666; font-weight: bold;">
                                üì± Qu√©t m√£ QR b·∫±ng app ng√¢n h√†ng ƒë·ªÉ thanh to√°n
                            </p>
                            <p style="margin: 0; font-size: 9px; color: #28a745;">
                                üí∞ S·ªë ti·ªÅn: ${formatCurrency(finalTotal)} | üè™ PayOS VietQR
                            </p>
                        </div>
                    ` : `
                        <div style="text-align: center; border-top: 1px dashed #000; padding-top: 15px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold; color: #999;">‚ùå PAYOS QR KH√îNG KH·∫¢ D·ª§NG</p>
                        </div>
                    `}
                    
                    <div style="text-align: center; font-size: 12px; border-top: 1px dashed #000; padding-top: 10px;">
                        <p style="margin: 0 0 5px 0; color: #ff6b35;"><strong>‚è≥ H√ìA ƒê∆†N T·∫†M - CH∆ØA THANH TO√ÅN</strong></p>
                        <p style="margin: 0; color: #666;">
                            ${hasPayOSQR ? 
                                'üì± Qu√©t m√£ QR tr√™n ƒë·ªÉ thanh to√°n ngay' : 
                                'üí∞ Vui l√≤ng thanh to√°n t·∫°i qu·∫ßy ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng'
                            }
                        </p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html> 