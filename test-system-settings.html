<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test System Settings - Thu·∫ø VAT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .test-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 50px auto;
            max-width: 1000px;
            overflow: hidden;
        }
        
        .test-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .demo-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .calculation-result {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .test-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,123,255,0.3);
        }
        
        .current-settings {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ Test C√†i ƒê·∫∑t H·ªá Th·ªëng - Thu·∫ø VAT</h1>
            <p class="mb-0">Ki·ªÉm tra ch·ª©c nƒÉng ƒëi·ªÅu ch·ªânh thu·∫ø su·∫•t tr√™n to√†n h·ªá th·ªëng</p>
        </div>
        
        <div class="container-fluid p-4">
            <!-- Current Settings Display -->
            <div class="current-settings">
                <h4>üìä C√†i ƒê·∫∑t Hi·ªán T·∫°i</h4>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Thu·∫ø VAT:</strong><br>
                        <span id="currentVatDisplay" class="h3">8.0%</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Ti·ªÅn t·ªá:</strong><br>
                        <span id="currentCurrency">VNƒê</span>
                    </div>
                    <div class="col-md-3">
                        <strong>ƒê·ªãnh d·∫°ng ng√†y:</strong><br>
                        <span id="currentDateFormat">DD/MM/YYYY</span>
                    </div>
                    <div class="col-md-3">
                        <strong>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</strong><br>
                        <span id="lastUpdated">Ch∆∞a c√≥</span>
                    </div>
                </div>
            </div>
            
            <!-- Test Calculation Section -->
            <div class="demo-section">
                <h4>üßÆ Test T√≠nh To√°n Thu·∫ø</h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>S·ªë ti·ªÅn g·ªëc (VNƒê):</strong></label>
                        <input type="number" class="form-control" id="testAmount" value="100000" placeholder="Nh·∫≠p s·ªë ti·ªÅn">
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn test-button w-100" onclick="calculateTest()">
                            T√≠nh To√°n Thu·∫ø
                        </button>
                    </div>
                </div>
                
                <div id="calculationResults" class="mt-3"></div>
            </div>
            
            <!-- Quick Settings Test -->
            <div class="demo-section">
                <h4>‚ö° Test Nhanh Thay ƒê·ªïi Thu·∫ø</h4>
                <div class="row g-2">
                    <div class="col">
                        <button class="btn btn-outline-primary w-100" onclick="setVatRate(5)">5% VAT</button>
                    </div>
                    <div class="col">
                        <button class="btn btn-outline-primary w-100" onclick="setVatRate(8)">8% VAT</button>
                    </div>
                    <div class="col">
                        <button class="btn btn-outline-primary w-100" onclick="setVatRate(10)">10% VAT</button>
                    </div>
                    <div class="col">
                        <button class="btn btn-outline-danger w-100" onclick="resetSettings()">Reset</button>
                    </div>
                </div>
            </div>
            
            <!-- System Integration Test -->
            <div class="demo-section">
                <h4>üîó Test T√≠ch H·ª£p H·ªá Th·ªëng</h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <button class="btn btn-success w-100" onclick="openManagerDashboard()">
                            üéõÔ∏è M·ªü Manager Dashboard
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-info w-100" onclick="testSystemWideUpdate()">
                            üîÑ Test C·∫≠p Nh·∫≠t To√†n H·ªá Th·ªëng
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Event Log -->
            <div class="demo-section">
                <h4>üìù Event Log</h4>
                <div id="eventLog" style="height: 200px; overflow-y: auto; background: #333; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace;">
                    <div>[SYSTEM] Test page loaded...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Utility functions for system settings (copied from main system)
        function getSystemSettings() {
            const defaultSettings = {
                business: {
                    vatRate: 0.08,
                    maxTablesPerWaiter: 6,
                    orderTimeout: 30,
                    maxDiscountPercent: 50,
                    inventoryVarianceThreshold: 10
                },
                ui: {
                    currency: 'VNƒê',
                    dateFormat: 'DD/MM/YYYY'
                }
            };
            
            const saved = localStorage.getItem('systemSettings');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    return {
                        business: { ...defaultSettings.business, ...parsed.business },
                        ui: { ...defaultSettings.ui, ...parsed.ui }
                    };
                } catch (error) {
                    logEvent('ERROR: Error parsing settings, using defaults');
                    return defaultSettings;
                }
            }
            return defaultSettings;
        }
        
        function saveSystemSettings(settings) {
            localStorage.setItem('systemSettings', JSON.stringify(settings));
            window.dispatchEvent(new CustomEvent('systemSettingsUpdated', { detail: settings }));
            logEvent('SUCCESS: Settings saved to localStorage');
            updateCurrentDisplay();
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function logEvent(message) {
            const logElement = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateCurrentDisplay() {
            const settings = getSystemSettings();
            document.getElementById('currentVatDisplay').textContent = (settings.business.vatRate * 100).toFixed(1) + '%';
            document.getElementById('currentCurrency').textContent = settings.ui.currency;
            document.getElementById('currentDateFormat').textContent = settings.ui.dateFormat;
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString('vi-VN');
            
            logEvent('INFO: Display updated with current settings');
        }
        
        function calculateTest() {
            const amount = parseFloat(document.getElementById('testAmount').value) || 0;
            const settings = getSystemSettings();
            const vatRate = settings.business.vatRate;
            const vatAmount = amount * vatRate;
            const totalAmount = amount + vatAmount;
            
            const resultsHTML = `
                <div class="calculation-result">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>S·ªë ti·ªÅn g·ªëc:</strong><br>
                            ${formatCurrency(amount)}
                        </div>
                        <div class="col-md-3">
                            <strong>Thu·∫ø VAT (${(vatRate * 100).toFixed(1)}%):</strong><br>
                            ${formatCurrency(vatAmount)}
                        </div>
                        <div class="col-md-3">
                            <strong>T·ªïng c·ªông:</strong><br>
                            ${formatCurrency(totalAmount)}
                        </div>
                        <div class="col-md-3">
                            <strong>T·ª∑ l·ªá thu·∫ø:</strong><br>
                            ${((vatAmount / totalAmount) * 100).toFixed(1)}% c·ªßa t·ªïng
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('calculationResults').innerHTML = resultsHTML;
            logEvent(`CALC: ${formatCurrency(amount)} + ${(vatRate * 100).toFixed(1)}% VAT = ${formatCurrency(totalAmount)}`);
        }
        
        function setVatRate(rate) {
            const settings = getSystemSettings();
            settings.business.vatRate = rate / 100;
            saveSystemSettings(settings);
            logEvent(`UPDATE: VAT rate changed to ${rate}%`);
            
            // Auto calculate if amount is entered
            const testAmount = document.getElementById('testAmount').value;
            if (testAmount) {
                calculateTest();
            }
        }
        
        function resetSettings() {
            localStorage.removeItem('systemSettings');
            updateCurrentDisplay();
            logEvent('RESET: Settings reset to defaults');
            
            // Clear calculation results
            document.getElementById('calculationResults').innerHTML = '';
        }
        
        function openManagerDashboard() {
            const url = '/dashboard/manager-dashboard.html';
            window.open(url, '_blank');
            logEvent('NAVIGATE: Opened Manager Dashboard in new tab');
        }
        
        function testSystemWideUpdate() {
            logEvent('TEST: Starting system-wide update test...');
            
            // Simulate system-wide update
            const settings = getSystemSettings();
            const newVatRate = Math.random() * 0.15 + 0.05; // Random rate between 5% and 20%
            settings.business.vatRate = newVatRate;
            
            saveSystemSettings(settings);
            
            // Dispatch event to all listeners
            window.dispatchEvent(new CustomEvent('systemSettingsUpdated', { detail: settings }));
            
            logEvent(`TEST: System-wide VAT rate updated to ${(newVatRate * 100).toFixed(2)}%`);
            logEvent('TEST: Event dispatched to all listeners');
            
            // Auto calculate to show effect
            if (document.getElementById('testAmount').value) {
                calculateTest();
            }
        }
        
        // Event listeners
        window.addEventListener('systemSettingsUpdated', function(event) {
            logEvent('EVENT: Received systemSettingsUpdated event');
            updateCurrentDisplay();
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDisplay();
            logEvent('INIT: Test page initialized successfully');
            
            // Auto calculate on amount change
            document.getElementById('testAmount').addEventListener('input', function() {
                if (this.value) {
                    calculateTest();
                }
            });
        });
    </script>
</body>
</html>
