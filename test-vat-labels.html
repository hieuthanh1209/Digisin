<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test VAT Label Preservation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="src/utils/vat-manager.js"></script>
    <style>
        .historical-invoice {
            border-left: 4px solid #28a745;
            background-color: #f8f9fa;
        }
        
        .current-invoice {
            border-left: 4px solid #ffc107;
            background-color: #fff9c4;
        }
        
        .vat-highlight {
            background-color: #e3f2fd;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .timestamp-tag {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i data-lucide="tag" class="me-2"></i>
                            Test VAT Label Preservation
                        </h4>
                        <small>Kiểm tra việc giữ lại label thuế của các hóa đơn cũ</small>
                    </div>
                    <div class="card-body">
                        <!-- Current VAT Rate Display -->
                        <div class="alert alert-info">
                            <h6><i data-lucide="info" class="me-2"></i>Thuế suất hiện tại</h6>
                            <div class="d-flex justify-content-between">
                                <span>Rate:</span>
                                <span id="currentVatRate" class="fw-bold">8.0%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Label (VI):</span>
                                <span id="currentVatLabelVi" class="fw-bold">Thuế VAT (8.0%):</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Label (EN):</span>
                                <span id="currentVatLabelEn" class="fw-bold">VAT (8.0%):</span>
                            </div>
                        </div>

                        <!-- VAT Rate Management -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Thay đổi thuế suất</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Thuế suất mới (%)</label>
                                            <input type="number" id="newVatRate" class="form-control" 
                                                   value="10.0" min="0" max="100" step="0.1">
                                        </div>
                                        <button class="btn btn-primary" onclick="changeVatRate()">
                                            <i data-lucide="refresh-cw" class="me-2"></i>
                                            Cập nhật thuế suất
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Tạo hóa đơn test</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Thời gian hóa đơn</label>
                                            <input type="datetime-local" id="invoiceTime" class="form-control">
                                        </div>
                                        <button class="btn btn-success" onclick="createTestInvoice()">
                                            <i data-lucide="plus" class="me-2"></i>
                                            Tạo hóa đơn
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Test Invoices Display -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Danh sách hóa đơn test</h6>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearInvoices()">
                                            <i data-lucide="trash-2" class="me-1"></i>
                                            Xóa tất cả
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="invoicesList">
                                            <div class="text-center text-muted py-4">
                                                <i data-lucide="file-text" style="width: 48px; height: 48px;" class="mb-3"></i>
                                                <p>Chưa có hóa đơn test nào</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            updateCurrentVatDisplay();
            loadTestInvoices();
            
            // Set default datetime to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('invoiceTime').value = now.toISOString().slice(0, 16);
        });

        function updateCurrentVatDisplay() {
            const currentRate = getCurrentVatRate();
            const currentLabelVi = getCurrentVatLabel('vi');
            const currentLabelEn = getCurrentVatLabel('en');
            
            document.getElementById('currentVatRate').textContent = (currentRate * 100).toFixed(1) + '%';
            document.getElementById('currentVatLabelVi').textContent = currentLabelVi;
            document.getElementById('currentVatLabelEn').textContent = currentLabelEn;
        }

        function changeVatRate() {
            const newRatePercent = parseFloat(document.getElementById('newVatRate').value);
            if (isNaN(newRatePercent) || newRatePercent < 0 || newRatePercent > 100) {
                alert('Vui lòng nhập thuế suất hợp lệ (0-100%)');
                return;
            }
            
            const newRate = newRatePercent / 100;
            const reason = `Test change to ${newRatePercent.toFixed(1)}%`;
            
            // Record VAT rate change
            recordVatRateChange(newRate, 'Test User', reason);
            
            // Update system settings
            const settings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
            if (!settings.business) settings.business = {};
            settings.business.vatRate = newRate;
            localStorage.setItem('systemSettings', JSON.stringify(settings));
            
            // Update display
            updateCurrentVatDisplay();
            loadTestInvoices(); // Refresh to show difference
            
            alert(`Thuế suất đã được cập nhật thành ${newRatePercent.toFixed(1)}%`);
        }

        function createTestInvoice() {
            const invoiceTime = document.getElementById('invoiceTime').value;
            if (!invoiceTime) {
                alert('Vui lòng chọn thời gian hóa đơn');
                return;
            }
            
            const timestamp = new Date(invoiceTime).toISOString();
            const invoiceId = 'INV-' + Date.now();
            
            // Sample invoice data
            const items = [
                { name: 'Phở bò', price: 50000, quantity: 2 },
                { name: 'Cà phê đen', price: 15000, quantity: 1 }
            ];
            
            const subtotal = items.reduce((total, item) => total + (item.price * item.quantity), 0);
            
            // Get VAT rate and labels for the specified time
            const vatRate = getVatRateForOrder(timestamp);
            const vatLabelVi = getVatLabelForOrder(timestamp, 'vi');
            const vatLabelEn = getVatLabelForOrder(timestamp, 'en');
            const vatAmount = subtotal * vatRate;
            const total = subtotal + vatAmount;
            
            const invoice = {
                id: invoiceId,
                timestamp: timestamp,
                items: items,
                subtotal: subtotal,
                vatRate: vatRate,
                vatAmount: vatAmount,
                total: total,
                vatLabelVi: vatLabelVi,
                vatLabelEn: vatLabelEn,
                vatPercentage: (vatRate * 100).toFixed(1) + '%'
            };
            
            // Save to localStorage
            const invoices = JSON.parse(localStorage.getItem('testInvoices') || '[]');
            invoices.push(invoice);
            localStorage.setItem('testInvoices', JSON.stringify(invoices));
            
            loadTestInvoices();
            
            console.log('Created test invoice:', invoice);
        }

        function loadTestInvoices() {
            const invoices = JSON.parse(localStorage.getItem('testInvoices') || '[]');
            const invoicesList = document.getElementById('invoicesList');
            
            if (invoices.length === 0) {
                invoicesList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i data-lucide="file-text" style="width: 48px; height: 48px;" class="mb-3"></i>
                        <p>Chưa có hóa đơn test nào</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            // Sort by timestamp (newest first)
            const sortedInvoices = invoices.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const currentTime = new Date();
            const currentVatRate = getCurrentVatRate();
            
            const invoicesHtml = sortedInvoices.map(invoice => {
                const invoiceDate = new Date(invoice.timestamp);
                const isHistorical = invoice.vatRate !== currentVatRate;
                const relativeTime = Math.floor((currentTime - invoiceDate) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="card mb-3 ${isHistorical ? 'historical-invoice' : 'current-invoice'}">
                        <div class="card-header d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${invoice.id}</h6>
                                <div class="timestamp-tag">${invoiceDate.toLocaleString('vi-VN')}</div>
                            </div>
                            <div class="text-end">
                                <span class="badge ${isHistorical ? 'bg-success' : 'bg-warning'}">
                                    ${isHistorical ? 'Historical' : 'Current Rate'}
                                </span>
                                <br>
                                <small class="text-muted">
                                    ${relativeTime === 0 ? 'Today' : `${relativeTime} days ago`}
                                </small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Items:</h6>
                                    <ul class="list-unstyled">
                                        ${invoice.items.map(item => 
                                            `<li>${item.quantity}x ${item.name}: ${formatCurrency(item.price * item.quantity)}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Calculation:</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>Subtotal:</span>
                                        <span>${formatCurrency(invoice.subtotal)}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="vat-highlight">${invoice.vatLabelVi}</span>
                                        <span class="vat-highlight">${formatCurrency(invoice.vatAmount)}</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>Total:</span>
                                        <span>${formatCurrency(invoice.total)}</span>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <strong>VAT Details:</strong><br>
                                            Rate: ${invoice.vatPercentage}<br>
                                            Label VI: ${invoice.vatLabelVi}<br>
                                            Label EN: ${invoice.vatLabelEn}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="migrateInvoice('${invoice.id}')">
                                    <i data-lucide="refresh-cw" class="me-1"></i>
                                    Test Migration
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteInvoice('${invoice.id}')">
                                    <i data-lucide="trash-2" class="me-1"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            invoicesList.innerHTML = invoicesHtml;
            lucide.createIcons();
        }

        function migrateInvoice(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('testInvoices') || '[]');
            const invoiceIndex = invoices.findIndex(inv => inv.id === invoiceId);
            
            if (invoiceIndex === -1) return;
            
            const originalInvoice = invoices[invoiceIndex];
            
            // Create a copy without VAT labels to simulate old data
            const oldFormatInvoice = {
                id: originalInvoice.id,
                timestamp: originalInvoice.timestamp,
                items: originalInvoice.items,
                subtotal: originalInvoice.subtotal,
                vatRate: originalInvoice.vatRate,
                vatAmount: originalInvoice.vatAmount,
                total: originalInvoice.total
                // No vatLabelVi, vatLabelEn - simulating old format
            };
            
            console.log('Original invoice (old format):', oldFormatInvoice);
            
            // Test migration
            const migratedInvoice = migrateOrderVatLabels(oldFormatInvoice);
            console.log('Migrated invoice:', migratedInvoice);
            
            // Test label retrieval
            const retrievedLabel = getOrderVatLabel(migratedInvoice, 'vi');
            console.log('Retrieved VAT label:', retrievedLabel);
            
            alert(`Migration test completed!\n\nOriginal had labels: ${originalInvoice.vatLabelVi ? 'Yes' : 'No'}\nMigrated labels: ${migratedInvoice.vatLabelVi}\nRetrieved label: ${retrievedLabel}\n\nCheck console for details.`);
        }

        function deleteInvoice(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('testInvoices') || '[]');
            const updatedInvoices = invoices.filter(inv => inv.id !== invoiceId);
            localStorage.setItem('testInvoices', JSON.stringify(updatedInvoices));
            loadTestInvoices();
        }

        function clearInvoices() {
            if (confirm('Bạn có chắc muốn xóa tất cả hóa đơn test?')) {
                localStorage.removeItem('testInvoices');
                loadTestInvoices();
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
    </script>
</body>
</html>
